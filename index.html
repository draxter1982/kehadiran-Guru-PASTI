<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Kehadiran Guru PASTI AL-HUDA</title>
    
    <!-- 1. TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. REACT & REACT DOM -->
    <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- 3. RECHARTS & DEPENDENCIES -->
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.12.0/Recharts.min.js"></script>

    <!-- 4. BABEL -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 5. PHOSPHOR ICONS -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- 6. HTML5-QRCODE (PENGIMBAS KAMERA SEBENAR) -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .loading-bar-transition { transition: width 0.1s linear; }
        
        .camera-overlay { background: rgba(0,0,0,0.95); }
        
        /* Custom style untuk scanner library */
        #reader { width: 100%; border: none !important; }
        #reader__scan_region { background: white; }
        #reader__dashboard_section_csr button { 
            background-color: #2563eb; color: white; padding: 8px 16px; border-radius: 6px; border: none; font-weight: bold; margin-top: 10px; cursor: pointer;
        }
        #reader video { 
            object-fit: cover; 
            width: 100% !important; 
            height: 100% !important; 
            border-radius: 0.5rem;
        }

        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            
            /* Specific fix for Report Printing */
            .report-print-mode { 
                visibility: visible; 
                position: absolute; 
                top: 0; 
                left: 0; 
                width: 100%; 
                background: white; 
                z-index: 9999;
                padding: 20px;
            }
            .report-print-mode * { visibility: visible; }
            body > *:not(.report-print-mode) { display: none; }
        }
        .print-only { display: none; }
    </style>

    <!-- 7. FIREBASE SETUP -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =================================================================================
        // PENTING: UNTUK DATA TALLY (ONLINE), ANDA PERLU MENGISI BAHAGIAN INI
        // =================================================================================
        
        const manualConfig = {
            apiKey: "AIzaSyCQtQsuXQHK8IFy6TqDtz3J8106NW8cRiQ",
            authDomain: "kehadiran-guru-pasti.firebaseapp.com",
            projectId: "kehadiran-guru-pasti",
            storageBucket: "kehadiran-guru-pasti.firebasestorage.app",
            messagingSenderId: "605108935164",
            appId: "1:605108935164:web:96cb7a2a5f4a9b81d5fa79",
            measurementId: "G-R509G76MS2"
        };
        // =================================================================================

        // --- SISTEM PEMILIHAN MOD ---
        let firebaseConfig = null;
        
        // 1. Cek Manual Config dahulu
        if (manualConfig && manualConfig.apiKey) {
            firebaseConfig = manualConfig;
        } 
        // 2. Cek Environment Variable (untuk preview dalaman)
        else {
            try {
                if (typeof __firebase_config !== 'undefined') {
                    firebaseConfig = JSON.parse(__firebase_config);
                }
            } catch (e) { console.warn("Tiada config env, beralih ke mod demo."); }
        }

        if (firebaseConfig) {
            try {
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                const db = getFirestore(app);
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                window.firebaseOps = { 
                    auth, db, appId, mode: 'online',
                    signInAnonymously, signInWithCustomToken, onAuthStateChanged, 
                    collection, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot 
                };
                console.log("Firebase initialized successfully (Online)");
            } catch (error) {
                console.error("Firebase init failed:", error);
                window.firebaseInitError = error.message;
                initDemoMode();
            }
        } else {
            initDemoMode();
        }

        function initDemoMode() {
            console.warn("Menggunakan Mod Demo (Simpanan Tempatan)");
            const getLocal = (key) => JSON.parse(localStorage.getItem('demo_' + key) || '[]');
            const setLocal = (key, data) => localStorage.setItem('demo_' + key, JSON.stringify(data));
            const listeners = {}; 
            const notify = (key) => {
                if (listeners[key]) {
                    const data = getLocal(key);
                    const snapshot = { docs: data.map(d => ({ id: d.id, data: () => d, exists: () => true })) };
                    const docSnapshot = { exists: () => data.length > 0, data: () => data[0] || {} }; 
                    listeners[key].forEach(cb => {
                        if (key.includes('_config')) cb(docSnapshot);
                        else cb(snapshot);
                    });
                }
            };
            const mockUser = { uid: 'demo-user-123', isAnonymous: true };
            window.firebaseOps = {
                mode: 'demo', auth: { currentUser: mockUser }, appId: 'demo-app',
                signInAnonymously: async () => ({ user: mockUser }),
                signInWithCustomToken: async () => ({ user: mockUser }),
                onAuthStateChanged: (auth, cb) => { cb(mockUser); return () => {}; },
                collection: (db, ...path) => ({ type: 'col', key: path[path.length - 1] }),
                doc: (db, ...path) => ({ type: 'doc', key: path[path.length - 1], id: path[path.length - 1] === 'config' ? 'config' : path[path.length - 1] }),
                onSnapshot: (ref, cb) => {
                    const key = ref.key === 'config' ? 'settings_config' : 'teachers';
                    if (!listeners[key]) listeners[key] = [];
                    listeners[key].push(cb); notify(key); return () => {};
                },
                addDoc: async (ref, data) => {
                    const key = 'teachers'; const list = getLocal(key); const newId = 'demo_' + Date.now();
                    list.push({ id: newId, ...data }); setLocal(key, list); notify(key); return { id: newId };
                },
                updateDoc: async (ref, data) => {
                    const key = 'teachers'; const list = getLocal(key); const idx = list.findIndex(i => i.id === ref.id);
                    if (idx !== -1) { list[idx] = { ...list[idx], ...data }; setLocal(key, list); notify(key); }
                },
                deleteDoc: async (ref) => {
                    const key = 'teachers'; let list = getLocal(key); list = list.filter(i => i.id !== ref.id);
                    setLocal(key, list); notify(key);
                },
                setDoc: async (ref, data) => {
                    if (ref.key === 'config') { setLocal('settings_config', [data]); notify('settings_config'); }
                }
            };
        }
    </script>
</head>
<body class="bg-gray-50 text-gray-900 font-sans">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const RechartsObj = window.Recharts || {};
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, Cell } = RechartsObj;
        const isRechartsLoaded = !!window.Recharts;

        const BRANCHES = ['PAH1', 'PAH2', 'PAH3', 'PAH5'];
        const MONTHS = ['Januari', 'Februari', 'Mac', 'April', 'Mei', 'Jun', 'Julai', 'Ogos', 'September', 'Oktober', 'November', 'Disember'];

        const seededRandom = (seed) => {
            let value = 0;
            for(let i=0; i<seed.length; i++) value += seed.charCodeAt(i);
            const x = Math.sin(value) * 10000;
            return x - Math.floor(x);
        };

        // --- HELPER: FORMAT MASA (12 JAM) ---
        const formatTime12 = (time24) => {
            if (!time24 || time24 === '--:--' || time24 === '-') return '--:--';
            try {
                const [hours, minutes] = time24.split(':').map(Number);
                if (isNaN(hours) || isNaN(minutes)) return time24;
                const ampm = hours >= 12 ? 'PM' : 'AM';
                const hours12 = hours % 12 || 12;
                return `${hours12}:${minutes.toString().padStart(2, '0')} ${ampm}`;
            } catch (e) { return time24; }
        };

        const ensureAuthReady = async () => {
            let attempts = 0;
            while (!window.firebaseOps && attempts < 50) { await new Promise(r => setTimeout(r, 100)); attempts++; }
            if (!window.firebaseOps) return false;
            if (window.firebaseOps.mode === 'demo') return true;
            const { auth, signInAnonymously } = window.firebaseOps;
            if (auth.currentUser) return true;
            try {
                await signInAnonymously(auth);
                let loginAttempts = 0;
                while (!auth.currentUser && loginAttempts < 50) { await new Promise(r => setTimeout(r, 100)); loginAttempts++; }
                return !!auth.currentUser;
            } catch (e) { return false; }
        };

        // --- COMPONENT: LOADING SCREEN ---
        const LoadingScreen = ({ progress, onSkip, errorMsg, mode }) => (
            <div className="fixed inset-0 bg-green-700 flex flex-col items-center justify-center z-50 text-white">
                <div className="relative mb-8">
                    <div className="w-24 h-24 border-4 border-green-400 border-t-white rounded-full animate-spin"></div>
                    <div className="absolute inset-0 flex items-center justify-center font-bold text-xl drop-shadow-md">{progress}%</div>
                </div>
                <h1 className="text-3xl font-bold mb-2 tracking-wide drop-shadow-md">SISTEM PASTI</h1>
                <p className="text-green-100 text-sm mb-2 animate-pulse font-medium">
                    {errorMsg ? 'Ralat Sambungan' : (mode === 'online' ? 'Menghubungkan ke Awan (Online)...' : 'Memulakan Mod Demo (Offline)...')}
                </p>
                {errorMsg && <p className="text-red-300 text-xs mb-4 bg-red-900/50 p-2 rounded">{errorMsg}</p>}
                <div className="w-64 h-3 bg-green-900 rounded-full overflow-hidden shadow-inner border border-green-600 mb-6">
                    <div className="h-full bg-white loading-bar-transition shadow-lg" style={{ width: `${progress}%` }}></div>
                </div>
                <button onClick={onSkip} className="text-xs font-bold text-green-200 hover:text-white underline hover:no-underline transition-colors opacity-80">
                    Langkau & Masuk Segera &gt;&gt;
                </button>
            </div>
        );

        // --- SUB-COMPONENTS ---
        const Header = ({ userRole, view, setView, isAdmin, onLogout, schoolName, logoUrl, isOnline, currentTeacher, isDemo }) => (
            <div className="bg-green-600 text-white p-4 shadow-md flex justify-between items-center sticky top-0 z-50 no-print">
                <div className="flex items-center gap-3">
                    {logoUrl ? <img src={logoUrl} alt="Logo" className="w-10 h-10 object-contain rounded-full bg-white p-1" /> : <i className="ph ph-user-check text-3xl"></i>}
                    <div>
                        <h1 className="text-xl font-bold leading-none uppercase">{schoolName || 'PASTI'}</h1>
                        <div className="flex flex-col text-xs text-green-100 opacity-90 mt-1">
                            <span className="font-semibold">{currentTeacher ? `Hi, ${currentTeacher.name}` : (userRole === 'admin' ? 'Panel Pentadbir' : 'Mod Guru')}</span>
                            <span className="flex items-center gap-1" title="Status Sambungan">
                                <span className={`w-2 h-2 rounded-full ${isDemo ? 'bg-blue-400' : (isOnline ? 'bg-green-300' : 'bg-yellow-400 animate-pulse')}`}></span>
                                {isDemo ? 'Mod Demo (Local)' : (isOnline ? 'Online' : 'Menghubungkan...')}
                            </span>
                        </div>
                    </div>
                </div>
                <div className="flex gap-2">
                    <button onClick={() => setView('dashboard')} className={`px-3 py-1 rounded text-sm font-bold ${view === 'dashboard' ? 'bg-white text-green-700' : 'bg-green-700'}`}>Utama</button>
                    {userRole === 'guru' && <button onClick={() => setView('scan')} className={`px-3 py-1 rounded text-sm font-bold ${view === 'scan' ? 'bg-white text-green-700' : 'bg-green-700 border border-green-400'}`}><i className="ph ph-qr-code"></i> Imbas</button>}
                    {isAdmin && (
                        <>
                            <button onClick={() => setView('scan')} className={`px-3 py-1 rounded text-sm font-bold ${view === 'scan' ? 'bg-white text-green-700' : 'bg-green-700'}`}>Scan (Kiosk)</button>
                            <button onClick={() => setView('admin')} className={`px-3 py-1 rounded text-sm font-bold ${view === 'admin' ? 'bg-white text-green-700' : 'bg-green-700 border border-green-400'}`}><i className="ph ph-gear-six"></i> Admin</button>
                        </>
                    )}
                    <button onClick={onLogout} className="ml-2 px-3 py-1 rounded text-sm font-bold bg-red-600 hover:bg-red-700 flex items-center gap-1"><i className="ph ph-sign-out"></i></button>
                </div>
            </div>
        );

        const LoginScreen = ({ onLogin, schoolName, logoUrl, teachers }) => {
            const [loginStep, setLoginStep] = useState('role_select'); 
            const [pass, setPass] = useState('');
            const [selectedBranch, setSelectedBranch] = useState('');
            const [selectedTeacherId, setSelectedTeacherId] = useState('');

            const handleGuruLogin = () => {
                if (!selectedTeacherId) { alert("Sila pilih nama guru."); return; }
                const teacher = teachers.find(t => t.id === selectedTeacherId);
                onLogin('guru', teacher);
            };

            const handleAdminLogin = () => {
                if (pass === 'admin123') onLogin('admin');
                else alert('Kata laluan salah!');
            };

            const filteredTeachers = useMemo(() => {
                if (!selectedBranch) return [];
                return teachers.filter(t => t.branch === selectedBranch);
            }, [selectedBranch, teachers]);

            return (
                <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-xl w-full max-w-md overflow-hidden animate-fade-in">
                        <div className="bg-green-600 p-8 text-center">
                            <div className="inline-block p-4 bg-white rounded-full text-green-600 mb-4 shadow-lg">
                                {logoUrl ? <img src={logoUrl} className="w-16 h-16 object-contain" /> : <i className="ph ph-user-circle text-5xl"></i>}
                            </div>
                            <h1 className="text-2xl font-bold text-white">Sistem Kehadiran</h1>
                            <p className="text-green-100 opacity-90 uppercase">{schoolName || 'PASTI'}</p>
                        </div>
                        <div className="p-8 space-y-6">
                            {loginStep === 'role_select' && (
                                <>
                                    <p className="text-center text-gray-500 mb-4 font-medium">Sila pilih akses anda:</p>
                                    <button onClick={() => setLoginStep('guru_select')} className="w-full py-4 bg-blue-50 border-2 border-blue-100 rounded-xl hover:bg-blue-100 transition-all flex items-center justify-center gap-3 group">
                                        <i className="ph ph-chalkboard-teacher text-3xl text-blue-600"></i>
                                        <div className="text-left"><span className="block text-lg font-bold text-blue-800">GURU</span><span className="text-xs text-blue-600">Log masuk untuk imbas kehadiran</span></div>
                                    </button>
                                    <button onClick={() => setLoginStep('admin_auth')} className="w-full py-4 bg-gray-50 border-2 border-gray-100 rounded-xl hover:bg-gray-100 transition-all flex items-center justify-center gap-3 group">
                                        <i className="ph ph-lock-key text-3xl text-gray-600"></i>
                                        <div className="text-left"><span className="block text-lg font-bold text-gray-800">PENTADBIR</span><span className="text-xs text-gray-500">Urus data dan laporan</span></div>
                                    </button>
                                </>
                            )}
                            {loginStep === 'guru_select' && (
                                <div className="animate-fade-in space-y-4">
                                    <h3 className="text-center font-bold text-blue-800 mb-2 text-lg">Log Masuk Guru</h3>
                                    <div>
                                        <label className="block text-sm font-bold text-gray-700 mb-1">1. Pilih Cawangan</label>
                                        <select className="w-full p-3 border-2 border-blue-100 rounded-lg focus:border-blue-500 outline-none bg-blue-50" value={selectedBranch} onChange={(e) => { setSelectedBranch(e.target.value); setSelectedTeacherId(''); }}>
                                            <option value="">-- Sila Pilih --</option>
                                            {BRANCHES.map(b => <option key={b} value={b}>{b}</option>)}
                                        </select>
                                    </div>
                                    <div className={`transition-opacity duration-300 ${selectedBranch ? 'opacity-100' : 'opacity-50 pointer-events-none'}`}>
                                        <label className="block text-sm font-bold text-gray-700 mb-1">2. Pilih Nama Anda</label>
                                        <select className="w-full p-3 border-2 border-blue-100 rounded-lg focus:border-blue-500 outline-none bg-white" value={selectedTeacherId} onChange={(e) => setSelectedTeacherId(e.target.value)}>
                                            <option value="">-- Cari Nama --</option>
                                            {filteredTeachers.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}
                                        </select>
                                    </div>
                                    <button onClick={handleGuruLogin} disabled={!selectedTeacherId} className={`w-full py-3 mt-4 text-white font-bold rounded-lg shadow-md transition-all ${selectedTeacherId ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-300 cursor-not-allowed'}`}>Masuk Sistem</button>
                                    <button onClick={() => setLoginStep('role_select')} className="w-full py-2 text-gray-500 text-sm hover:underline">Kembali</button>
                                </div>
                            )}
                            {loginStep === 'admin_auth' && (
                                <div className="animate-fade-in">
                                    <h3 className="text-center font-bold text-gray-800 mb-4 text-lg">Akses Pentadbir</h3>
                                    <input type="password" className="w-full p-3 border-2 border-gray-200 rounded-lg mb-4 text-center focus:border-green-500 focus:outline-none" placeholder="Masukkan Kata Laluan" value={pass} onChange={(e) => setPass(e.target.value)} autoFocus />
                                    <button onClick={handleAdminLogin} className="w-full py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 shadow-md mb-3">Sahkan</button>
                                    <button onClick={() => {setLoginStep('role_select'); setPass('');}} className="w-full py-2 text-gray-500 text-sm hover:underline">Kembali</button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const DashboardView = ({ teachers, isDemo }) => {
            const getChartData = () => {
                const stats = { Hadir: 0, 'Dalam Proses': 0, Cuti: 0, 'Tugas Luar': 0, 'Tidak Hadir': 0 };
                if (teachers) {
                    teachers.forEach(t => {
                        if (t.status === 'Hadir' && t.timeOut !== '--:--') stats['Hadir']++;
                        else if (t.status === 'Hadir' && t.timeOut === '--:--') stats['Dalam Proses']++;
                        else if (t.status === 'Cuti') stats['Cuti']++;
                        else if (t.status === 'Tugas Luar') stats['Tugas Luar']++;
                        else stats['Tidak Hadir']++;
                    });
                }
                return [
                    { name: 'Selesai', jumlah: stats['Hadir'], fill: '#22c55e' },
                    { name: 'Bertugas', jumlah: stats['Dalam Proses'], fill: '#3b82f6' },
                    { name: 'T. Luar', jumlah: stats['Tugas Luar'], fill: '#8b5cf6' },
                    { name: 'Cuti', jumlah: stats['Cuti'], fill: '#eab308' },
                    { name: 'Tiada', jumlah: stats['Tidak Hadir'], fill: '#ef4444' },
                ];
            };

            const data = getChartData();
            const today = new Date();
            const dateString = today.toLocaleDateString('ms-MY', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            return (
                <div className="p-4 space-y-6 max-w-5xl mx-auto animate-fade-in no-print">
                     {isDemo && (
                        <div className="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-4" role="alert">
                            <p className="font-bold">Amaran: Mod Demo (Local Storage)</p>
                            <p className="text-sm">Sistem ini sedang berjalan secara offline. Data TIDAK akan diselaraskan (tally) dengan peranti lain. Sila masukkan konfigurasi Firebase dalam kod untuk mengaktifkan mod Online.</p>
                        </div>
                    )}
                    <div className="grid grid-cols-2 md:grid-cols-5 gap-3">
                        {data.map((item, idx) => (
                            <div key={idx} className="bg-white p-3 rounded-lg shadow border-l-4" style={{ borderLeftColor: item.fill }}>
                                <p className="text-gray-500 text-xs font-semibold uppercase">{item.name}</p>
                                <p className="text-2xl font-bold text-gray-800">{item.jumlah}</p>
                            </div>
                        ))}
                    </div>
                    <div className="bg-white p-4 rounded-lg shadow">
                        <div className="flex flex-col md:flex-row justify-between items-center mb-4 gap-2">
                            {/* PEMBETULAN 1: Statistik Harian -> Statistik Bulanan */}
                            <h3 className="text-lg font-bold text-gray-700 flex items-center gap-2"><i className="ph ph-chart-bar text-xl"></i> Statistik Bulanan</h3>
                            <div className="flex items-center gap-2 text-sm font-medium text-gray-600 bg-gray-100 px-3 py-1.5 rounded-full border">
                                <i className="ph ph-calendar text-green-600"></i> <span>{dateString}</span>
                            </div>
                        </div>
                        <div className="h-64 w-full flex items-center justify-center bg-gray-50 rounded">
                            {isRechartsLoaded ? (
                                <ResponsiveContainer width="100%" height="100%">
                                    <BarChart data={data} layout="vertical" margin={{ top: 5, right: 30, left: 20, bottom: 5 }}>
                                        <CartesianGrid strokeDasharray="3 3" horizontal={true} vertical={false} />
                                        <XAxis type="number" hide />
                                        <YAxis dataKey="name" type="category" width={80} tick={{fontSize: 12}} />
                                        <Tooltip cursor={{fill: 'transparent'}} />
                                        <Bar dataKey="jumlah" radius={[0, 4, 4, 0]} barSize={30}>
                                            {data.map((entry, index) => <Cell key={`cell-${index}`} fill={entry.fill} />)}
                                        </Bar>
                                    </BarChart>
                                </ResponsiveContainer>
                            ) : ( <div className="text-gray-500 text-sm">Graf sedang dimuatkan...</div> )}
                        </div>
                    </div>
                    <div className="bg-white rounded-lg shadow overflow-hidden">
                        <div className="bg-gray-50 px-4 py-3 border-b flex justify-between items-center">
                            <h3 className="font-bold text-gray-700">Senarai Kehadiran Penuh</h3>
                            <div className="text-xs text-gray-400 italic">Data dikemaskini secara masa nyata (Real-time)</div>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className="text-xs text-gray-700 uppercase bg-gray-100">
                                    <tr>
                                        <th className="px-4 py-3">Nama Guru</th>
                                        <th className="px-4 py-3">Cawangan</th>
                                        <th className="px-4 py-3">Masuk</th>
                                        <th className="px-4 py-3">Balik</th>
                                        <th className="px-4 py-3">Status</th>
                                        <th className="px-4 py-3">Catatan</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {teachers.map((t, idx) => {
                                        let statusColor = "bg-white", badgeColor = "bg-gray-100 text-gray-800";
                                        if (t.status === 'Tidak Hadir') { statusColor = "bg-red-50"; badgeColor = "bg-red-100 text-red-800"; }
                                        else if (t.status === 'Cuti') badgeColor = "bg-yellow-100 text-yellow-800";
                                        else if (t.status === 'Hadir') badgeColor = "bg-green-100 text-green-800";
                                        else if (t.status === 'Tugas Luar') badgeColor = "bg-purple-100 text-purple-800";
                                        return (
                                            <tr key={idx} className={`border-b ${statusColor}`}>
                                                <td className="px-4 py-3 font-medium">{t.name}</td>
                                                <td className="px-4 py-3"><span className="px-2 py-1 bg-gray-100 rounded text-xs font-mono">{t.branch}</span></td>
                                                {/* PEMBETULAN 2: Format Masa AM/PM */}
                                                <td className="px-4 py-3 font-mono text-gray-600">{formatTime12(t.timeIn)}</td>
                                                <td className="px-4 py-3 font-mono text-gray-600">{formatTime12(t.timeOut)}</td>
                                                <td className="px-4 py-3"><span className={`px-2 py-1 rounded text-xs font-semibold ${badgeColor}`}>{t.status}</span></td>
                                                <td className="px-4 py-3 text-gray-500 italic truncate max-w-xs">{t.reason || '-'}</td>
                                            </tr>
                                        );
                                    })}
                                    {teachers.length === 0 && (<tr><td colSpan="6" className="text-center py-4 text-gray-500">Tiada data guru.</td></tr>)}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        const ScanView = ({ currentTeacher, teachers, userRole, handleAttendanceSubmit, handlePrint, isPrinting, schoolName }) => {
            const [isCameraOpen, setIsCameraOpen] = useState(false);
            const [notification, setNotification] = useState('');
            const [showReasonInput, setShowReasonInput] = useState(false);
            const [tempScanType, setTempScanType] = useState(null);
            const [leaveReason, setLeaveReason] = useState('');
            const [kioskTeacherId, setKioskTeacherId] = useState('');
            
            // Ref untuk pengimbas kamera
            const scannerRef = useRef(null);
            // Ref untuk elak trigger berulang & tambah delay
            const isProcessingRef = useRef(false);

            // --- FUNGSI KAMERA SEBENAR (Html5Qrcode) ---
            useEffect(() => {
                if (isCameraOpen && userRole === 'guru') {
                    // Reset lock setiap kali kamera dibuka
                    isProcessingRef.current = false;

                    // Gunakan sedikit delay untuk pastikan DOM 'reader' wujud
                    const timer = setTimeout(() => {
                         if(document.getElementById('reader')) {
                             // Initialize Html5Qrcode (Bukan Scanner widget) untuk kawalan penuh
                             const html5QrCode = new Html5Qrcode("reader");
                             scannerRef.current = html5QrCode;

                             // PEMBETULAN: Turunkan FPS ke 2 (Sangat perlahan untuk elak terlalu sensitif)
                             const config = { fps: 2, qrbox: { width: 250, height: 250 } };
                             
                             // Mula kamera belakang (environment)
                             html5QrCode.start(
                                 { facingMode: "environment" }, 
                                 config, 
                                 (decodedText) => {
                                     // Berjaya scan
                                     handleRealScan(decodedText);
                                 },
                                 (errorMessage) => {
                                     // Ralat imbasan (biasa jika tiada QR dikesan)
                                 }
                             ).catch(err => {
                                 console.error("Ralat memulakan kamera:", err);
                                 alert("Gagal memulakan kamera. Sila pastikan izin kamera diberikan.");
                                 setIsCameraOpen(false);
                             });
                         }
                    }, 300); // 300ms delay selamat

                    return () => clearTimeout(timer);
                }
                
                // Cleanup function
                return () => {
                    if(scannerRef.current) {
                        scannerRef.current.stop().then(() => {
                            scannerRef.current.clear();
                            scannerRef.current = null;
                        }).catch(err => console.log("Stop failed", err));
                    }
                };
            }, [isCameraOpen, userRole]);

            const stopCamera = () => {
                if (scannerRef.current) {
                    scannerRef.current.stop().then(() => {
                        scannerRef.current.clear();
                        setIsCameraOpen(false);
                    }).catch(err => {
                        console.error("Gagal tutup kamera", err);
                        setIsCameraOpen(false); // Force close UI anyway
                    });
                } else {
                    setIsCameraOpen(false);
                }
            };

            const handleRealScan = (text) => {
                if (isProcessingRef.current) return; // Jangan proses jika sedang proses
                if (!currentTeacher) return;
                
                // Peta kod QR kepada tindakan
                let type = null;
                if (text === 'PASTI_CLOCK_IN') type = 'clock_in';
                else if (text === 'PASTI_CLOCK_OUT') type = 'clock_out';
                else if (text === 'PASTI_OUTSTATION') type = 'outstation';
                else if (text === 'PASTI_LEAVE') type = 'leave';
                
                if (type) {
                    isProcessingRef.current = true; // Lock
                    
                    // Tunjuk feedback serta merta
                    setNotification("Kod Dikesan... Memproses...");

                    // PEMBETULAN: Tambah Delay 1.5 saat sebelum proses data
                    setTimeout(() => {
                        stopCamera();
                        
                        if (type === 'outstation' || type === 'leave') {
                            setTempScanType(type);
                            setShowReasonInput(true);
                            setNotification(""); // Clear notification bila masuk form
                            isProcessingRef.current = false; // Reset lock sebab UI bertukar ke form
                        } else {
                            handleAttendanceSubmit(currentTeacher.id, type);
                            setNotification(type === 'clock_in' ? "Masuk Berjaya!" : "Balik Berjaya!");
                            setTimeout(() => {
                                setNotification('');
                                isProcessingRef.current = false; // Reset lock selepas notifikasi hilang
                            }, 3000);
                        }
                    }, 1500); // Tunggu 1.5 saat
                } else {
                    // Jika QR salah, jangan lock lama-lama, alert terus
                    alert("Kod QR tidak sah: " + text);
                }
            };
            
            const submitReason = () => {
                if (tempScanType && currentTeacher) {
                    handleAttendanceSubmit(currentTeacher.id, tempScanType, leaveReason);
                    setNotification("Data direkodkan!");
                    setShowReasonInput(false);
                    setLeaveReason('');
                    setTempScanType(null);
                    setTimeout(() => setNotification(''), 3000);
                }
            };

            // Jika Guru (Personal Mode)
            if (userRole === 'guru' && currentTeacher) {
                // PAPARAN INPUT BORANG (SELEPAS SCAN CUTI/LUAR)
                if (showReasonInput) {
                     return (
                        <div className="p-4 md:p-8 max-w-xl mx-auto">
                            <div className="bg-white rounded-xl shadow-xl p-8 space-y-6">
                                <div className="text-center">
                                    <div className="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 mx-auto mb-4"><i className="ph ph-note-pencil text-3xl"></i></div>
                                    <h3 className="font-bold text-xl text-gray-800">Nyatakan Sebab / Lokasi</h3>
                                    <p className="text-gray-500 text-sm">Sila isi maklumat lanjut untuk rekod ini.</p>
                                </div>
                                <textarea 
                                    className="w-full p-4 border-2 border-blue-100 rounded-lg h-32 focus:border-blue-500 outline-none" 
                                    placeholder={tempScanType === 'leave' ? "Contoh: Demam, Urusan Keluarga..." : "Contoh: Mesyuarat di PPD, Kursus..."}
                                    value={leaveReason}
                                    onChange={(e) => setLeaveReason(e.target.value)}
                                    autoFocus
                                ></textarea>
                                <div className="flex gap-3">
                                    <button onClick={() => { setShowReasonInput(false); setLeaveReason(''); }} className="flex-1 py-3 bg-gray-100 text-gray-600 rounded-lg font-bold hover:bg-gray-200">Batal</button>
                                    <button onClick={submitReason} className="flex-1 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 shadow-md">Hantar Laporan</button>
                                </div>
                            </div>
                        </div>
                     );
                }

                return (
                    <div className="p-4 md:p-8 max-w-xl mx-auto">
                        <div className="bg-white rounded-xl shadow-xl p-8 text-center space-y-6">
                            <div className="flex flex-col items-center">
                                <div className="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 mb-4"><i className="ph ph-user text-4xl"></i></div>
                                <h2 className="text-2xl font-bold text-gray-800">{currentTeacher.name}</h2>
                                <span className="bg-blue-50 text-blue-700 px-3 py-1 rounded-full text-sm font-semibold mt-2">{currentTeacher.branch}</span>
                            </div>
                            <hr />
                            
                            {/* Butang Buka Kamera */}
                            {!isCameraOpen && (
                                <div className="space-y-4">
                                    <button 
                                        onClick={() => setIsCameraOpen(true)} 
                                        className="w-full py-12 bg-green-600 hover:bg-green-700 text-white rounded-2xl font-bold text-2xl shadow-xl flex flex-col items-center justify-center gap-4 transition-transform active:scale-95 border-4 border-green-500"
                                    >
                                        <div className="p-4 bg-white/20 rounded-full backdrop-blur-sm shadow-inner">
                                            <i className="ph ph-qr-code text-6xl"></i>
                                        </div>
                                        <div className="text-center">
                                            <span className="block text-3xl font-extrabold tracking-tight drop-shadow-md">IMBAS QR</span>
                                            <span className="text-green-100 font-medium text-sm mt-1 bg-black/10 px-3 py-1 rounded-full">Kamera Sebenar</span>
                                        </div>
                                    </button>
                                    <p className="text-gray-500 text-sm">Tekan butang di atas untuk mengimbas kod QR dinding.</p>
                                </div>
                            )}

                            {/* Tempat Render Kamera */}
                            {isCameraOpen && (
                                <div className="fixed inset-0 camera-overlay z-50 flex flex-col items-center justify-center p-4">
                                    <div className="relative w-full max-w-md bg-black rounded-2xl overflow-hidden shadow-2xl border-2 border-gray-700">
                                        <div className="bg-gray-900 p-4 flex justify-between items-center text-white">
                                            <h3 className="font-bold flex items-center gap-2"><i className="ph ph-camera"></i> Imbas QR</h3>
                                            <button onClick={stopCamera} className="text-gray-400 hover:text-white"><i className="ph ph-x text-2xl"></i></button>
                                        </div>
                                        
                                        {/* REAL CAMERA REGION */}
                                        <div id="reader" className="bg-black w-full h-80"></div>
                                        
                                        <div className="bg-gray-900 p-4 text-center text-gray-400 text-sm">
                                            Halakan kamera pada Kod QR dinding
                                        </div>
                                    </div>
                                </div>
                            )}

                            {notification && (
                                <div className="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 animate-fade-in z-50">
                                    <i className="ph ph-check-circle text-green-400 text-xl"></i><span className="font-semibold">{notification}</span>
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            // Jika Admin (Kiosk Mode / Print)
            return (
                <div className="p-4 md:p-8 max-w-6xl mx-auto">
                    <div className={`bg-white rounded-xl shadow-lg p-6 md:p-10 text-center space-y-8 no-print ${isPrinting ? 'hidden' : ''}`}>
                        <div className="flex flex-col md:flex-row justify-between items-center gap-4 border-b pb-6">
                            <div className="text-left"><h2 className="text-3xl font-bold text-gray-800">Cetak Kod QR</h2><p className="text-gray-500">Cetak kod ini dan tampal di dinding sekolah.</p></div>
                            <button onClick={handlePrint} className="flex items-center gap-2 bg-gray-800 text-white px-5 py-3 rounded-lg shadow hover:bg-gray-900 transition-all"><i className="ph ph-printer text-xl"></i> Cetak QR</button>
                        </div>
                        <div className="text-gray-400 italic py-10">Sila gunakan butang "Cetak QR" di atas.</div>
                    </div>
                    <div className={`print-only ${isPrinting ? 'block' : 'hidden'} bg-white p-8 w-full`}>
                        <div className="text-center mb-8 border-b-2 border-gray-800 pb-4"><h1 className="text-4xl font-bold text-gray-900">KOD QR KEHADIRAN {schoolName}</h1><p className="text-xl text-gray-600">Sila Imbas Menggunakan Aplikasi</p></div>
                        <div className="grid grid-cols-2 gap-8 text-center">
                            <div className="border-4 border-blue-600 rounded-2xl p-6 flex flex-col items-center"><h2 className="text-3xl font-extrabold text-blue-800 mb-2">QR MASUK</h2><img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=PASTI_CLOCK_IN" className="w-40 h-40 border-2 mb-4" /><p className="text-xl font-bold">REKOD DATANG</p></div>
                            <div className="border-4 border-rose-600 rounded-2xl p-6 flex flex-col items-center"><h2 className="text-3xl font-extrabold text-rose-800 mb-2">QR BALIK</h2><img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=PASTI_CLOCK_OUT" className="w-40 h-40 border-2 mb-4" /><p className="text-xl font-bold">REKOD PULANG</p></div>
                            <div className="border-4 border-purple-600 rounded-2xl p-6 flex flex-col items-center"><h2 className="text-3xl font-extrabold text-purple-800 mb-2">TUGAS LUAR</h2><img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=PASTI_OUTSTATION" className="w-40 h-40 border-2 mb-4" /><p className="text-xl font-bold">KURSUS</p></div>
                            <div className="border-4 border-orange-600 rounded-2xl p-6 flex flex-col items-center"><h2 className="text-3xl font-extrabold text-orange-800 mb-2">CUTI / MC</h2><img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=PASTI_LEAVE" className="w-40 h-40 border-2 mb-4" /><p className="text-xl font-bold">TIDAK HADIR</p></div>
                        </div>
                    </div>
                </div>
            );
        };

        const AdminView = ({ isAdmin, adminTab, setAdminTab, teachers, newTeacherName, setNewTeacherName, newTeacherBranch, setNewTeacherBranch, handleAddTeacher, handleDeleteTeacher, schoolName, setSchoolName, logoUrl, setLogoUrl, handleSaveSettings, handleResetDaily, isDemo }) => {
            if (!isAdmin) return <div className="p-8 text-center text-red-600">Akses Ditolak</div>;
            const [selectedMonth, setSelectedMonth] = useState('Januari');
            const [selectedBranchFilter, setSelectedBranchFilter] = useState('Semua');
            const [selectedTeacherFilter, setSelectedTeacherFilter] = useState('Semua');
            const [isPrintingReport, setIsPrintingReport] = useState(false);

            const generateReportData = (month, branchFilter, teacherFilter, teachersList) => {
                const monthIndex = MONTHS.indexOf(month);
                const year = 2026;
                // KIRAAN DINAMIK HARI DALAM BULAN
                const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();
                let reportData = [];
                
                // Dapatkan tarikh sebenar hari ini
                const today = new Date();
                const realDay = today.getDate();
                const realMonth = today.getMonth(); // 0 = Januari

                if(teachersList) {
                    teachersList.forEach(teacher => {
                        if (branchFilter !== 'Semua' && teacher.branch !== branchFilter) return;
                        if (teacherFilter !== 'Semua' && teacher.name !== teacherFilter) return;
                        
                        for (let i = 1; i <= daysInMonth; i++) {
                            let status = '-', timeIn = '-', timeOut = '-';
                            
                            // Papar data hanya jika tarikh gelung adalah HARI INI dan BULAN INI
                            // (Logik ini digunakan kerana tiada database sejarah dalam versi fail tunggal ini)
                            if (i === realDay && monthIndex === realMonth) {
                                status = teacher.status;
                                timeIn = teacher.timeIn;
                                timeOut = teacher.timeOut;
                            }
                            
                            // Jika bukan hari ini, data kekal '-'

                            reportData.push({ date: `${i} ${month} ${year}`, name: teacher.name, branch: teacher.branch, status: status, timeIn: timeIn, timeOut: timeOut });
                        }
                    });
                }
                return reportData;
            };
            const reportData = React.useMemo(() => { return generateReportData(selectedMonth, selectedBranchFilter, selectedTeacherFilter, teachers); }, [selectedMonth, selectedBranchFilter, selectedTeacherFilter, teachers]);

            // PEMBETULAN 4: Data Analisa Tahunan KOSONG (0)
            const annualData = [
                { name: 'Jan', hadir: 0 }, { name: 'Feb', hadir: 0 }, { name: 'Mac', hadir: 0 },
                { name: 'Apr', hadir: 0 }, { name: 'Mei', hadir: 0 }, { name: 'Jun', hadir: 0 },
                { name: 'Jul', hadir: 0 }, { name: 'Ogos', hadir: 0 }, { name: 'Sep', hadir: 0 },
                { name: 'Okt', hadir: 0 }, { name: 'Nov', hadir: 0 }, { name: 'Dis', hadir: 0 }
            ];

            const handlePrintReport = () => {
                setIsPrintingReport(true);
                setTimeout(() => {
                    window.print();
                    setIsPrintingReport(false);
                }, 500);
            };

            const handleExportCSV = () => {
                const headers = ["Tarikh", "Nama Guru", "Cawangan", "Status", "Masuk", "Balik"];
                const rows = reportData.map(r => [
                    r.date, 
                    r.name, 
                    r.branch, 
                    r.status, 
                    formatTime12(r.timeIn), 
                    formatTime12(r.timeOut)
                ]);
                
                let csvContent = "data:text/csv;charset=utf-8," 
                    + headers.join(",") + "\n" 
                    + rows.map(e => e.join(",")).join("\n");
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `Laporan_Kehadiran_${selectedMonth}_${new Date().getFullYear()}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            return (
                <div className="p-4 max-w-5xl mx-auto no-print">
                    <div className="flex justify-between items-center mb-6"><h2 className="text-2xl font-bold">Panel Pentadbir</h2><p className="text-gray-500 text-sm">Pengurusan Data Sekolah (Disinkron)</p></div>
                    {isDemo && (
                         <div className="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6" role="alert">
                            <p className="font-bold">Amaran: Mod Demo (Local Storage)</p>
                            <p className="text-sm">Sistem ini sedang berjalan secara offline. Data TIDAK akan diselaraskan (tally) dengan peranti lain. Sila masukkan konfigurasi Firebase dalam kod untuk mengaktifkan mod Online.</p>
                        </div>
                    )}
                    <div className="flex gap-2 mb-6 border-b overflow-x-auto pb-2">
                        <button onClick={() => setAdminTab('overview')} className={`px-4 py-2 font-bold rounded-t-lg whitespace-nowrap ${adminTab === 'overview' ? 'bg-white text-blue-600 border-t border-x' : 'text-gray-500 hover:bg-gray-50'}`}>Pengurusan</button>
                        <button onClick={() => setAdminTab('teachers')} className={`px-4 py-2 font-bold rounded-t-lg whitespace-nowrap ${adminTab === 'teachers' ? 'bg-white text-blue-600 border-t border-x' : 'text-gray-500 hover:bg-gray-50'}`}>Senarai Guru</button>
                        <button onClick={() => setAdminTab('report')} className={`px-4 py-2 font-bold rounded-t-lg whitespace-nowrap ${adminTab === 'report' ? 'bg-white text-blue-600 border-t border-x' : 'text-gray-500 hover:bg-gray-50'}`}>Laporan Bulanan</button>
                        <button onClick={() => setAdminTab('analysis')} className={`px-4 py-2 font-bold rounded-t-lg whitespace-nowrap ${adminTab === 'analysis' ? 'bg-white text-blue-600 border-t border-x' : 'text-gray-500 hover:bg-gray-50'}`}>Analisa</button>
                        <button onClick={() => setAdminTab('settings')} className={`px-4 py-2 font-bold rounded-t-lg whitespace-nowrap ${adminTab === 'settings' ? 'bg-white text-blue-600 border-t border-x' : 'text-gray-500 hover:bg-gray-50'}`}>Tetapan</button>
                    </div>
                    {adminTab === 'overview' && (
                        <div className="bg-white rounded-xl shadow-lg p-8 animate-fade-in">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                                <button onClick={() => setAdminTab('teachers')} className="flex items-center justify-center gap-2 px-4 py-4 bg-white border-2 border-dashed border-gray-300 text-gray-600 rounded-xl hover:border-blue-500 hover:text-blue-600"><i className="ph ph-users text-xl"></i> Urus Senarai Guru</button>
                                <button className="flex items-center justify-center gap-2 px-4 py-4 bg-white border-2 border-dashed border-gray-300 text-gray-600 rounded-xl hover:border-green-500 hover:text-green-600"><i className="ph ph-file-csv text-xl"></i> Eksport Excel</button>
                            </div>
                            <div className="border-t pt-6 bg-red-50 p-4 rounded-lg flex justify-between items-center">
                                <div><span className="text-red-700 font-bold block">Reset Harian</span><span className="text-xs text-red-500">Tindakan ini akan menetapkan semua guru kepada "Tidak Hadir" di semua peranti.</span></div>
                                <button onClick={handleResetDaily} className="px-4 py-2 bg-white border border-red-200 text-red-600 rounded font-bold hover:bg-red-50">Reset Sekarang</button>
                            </div>
                        </div>
                    )}
                    {adminTab === 'teachers' && (
                        <div className="bg-white rounded-xl shadow-lg p-6 animate-fade-in">
                            <h3 className="font-bold text-lg mb-4 flex items-center gap-2"><i className="ph ph-user-plus text-blue-600"></i> Tambah Guru Baru</h3>
                            <div className="flex flex-col md:flex-row gap-4 mb-8 p-4 bg-blue-50 rounded-lg">
                                <div className="flex-1"><label className="block text-sm font-bold text-blue-800 mb-1">Nama Penuh</label><input type="text" className="w-full p-2 border rounded" placeholder="Cth: Cikgu Ali" value={newTeacherName} onChange={(e) => setNewTeacherName(e.target.value)} /></div>
                                <div className="w-full md:w-48"><label className="block text-sm font-bold text-blue-800 mb-1">Cawangan</label><select className="w-full p-2 border rounded" value={newTeacherBranch} onChange={(e) => setNewTeacherBranch(e.target.value)}>{BRANCHES.map(b => <option key={b} value={b}>{b}</option>)}</select></div>
                                <div className="flex items-end"><button onClick={handleAddTeacher} className="w-full md:w-auto px-6 py-2 bg-blue-600 text-white font-bold rounded hover:bg-blue-700">Tambah</button></div>
                            </div>
                            <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-lg">Senarai Guru Sedia Ada</h3><div className="text-xs text-green-600 font-bold bg-green-50 px-2 py-1 rounded border border-green-200 flex items-center gap-1"><i className="ph ph-cloud-check"></i> Auto-Sync Aktif</div></div>
                            <div className="overflow-x-auto"><table className="w-full text-sm text-left border"><thead className="bg-gray-100 uppercase text-xs"><tr><th className="px-4 py-3">Nama Guru</th><th className="px-4 py-3">Cawangan</th><th className="px-4 py-3 text-center">Tindakan</th></tr></thead><tbody>{teachers.map((t) => (<tr key={t.id} className="border-b hover:bg-gray-50"><td className="px-4 py-3 font-bold">{t.name}</td><td className="px-4 py-3"><span className="px-2 py-1 bg-gray-200 rounded text-xs">{t.branch}</span></td><td className="px-4 py-3 text-center"><button onClick={() => handleDeleteTeacher(t.id)} className="text-red-600 hover:text-red-800 bg-red-50 hover:bg-red-100 px-3 py-1 rounded text-xs font-bold">Padam</button></td></tr>))} {teachers.length === 0 && (<tr><td colSpan="4" className="text-center py-4 text-gray-500">Tiada guru didaftarkan.</td></tr>)}</tbody></table></div>
                            <p className="text-xs text-gray-500 mt-4 italic">* Perubahan senarai guru disimpan secara automatik ke pangkalan data awan.</p>
                        </div>
                    )}
                    {adminTab === 'report' && (
                        <div className="bg-white rounded-xl shadow-lg p-6 animate-fade-in relative">
                            {/* Header & Controls - Hidden when printing via state/css trick */}
                            <div className="flex flex-col md:flex-row justify-between items-center mb-6">
                                <h3 className="font-bold text-lg flex items-center gap-2 text-purple-700"><i className="ph ph-file-text text-xl"></i> Rekod Kehadiran Bulanan</h3>
                                <div className="flex gap-2 mt-4 md:mt-0">
                                    <button onClick={handlePrintReport} className="flex items-center gap-2 px-4 py-2 bg-gray-800 text-white rounded-lg shadow hover:bg-gray-900 transition-all text-sm font-bold"><i className="ph ph-printer"></i> Cetak</button>
                                    <button onClick={handleExportCSV} className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg shadow hover:bg-green-700 transition-all text-sm font-bold"><i className="ph ph-microsoft-excel-logo"></i> Eksport CSV</button>
                                </div>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 bg-purple-50 p-4 rounded-lg no-print">
                                <div><label className="block text-xs font-bold text-purple-800 uppercase mb-1">Bulan</label><select className="w-full p-2 border border-purple-200 rounded text-sm focus:outline-none focus:ring-2 focus:ring-purple-500" value={selectedMonth} onChange={(e) => setSelectedMonth(e.target.value)}>{MONTHS.map(m => <option key={m} value={m}>{m}</option>)}</select></div>
                                <div><label className="block text-xs font-bold text-purple-800 uppercase mb-1">Cawangan</label><select className="w-full p-2 border border-purple-200 rounded text-sm focus:outline-none focus:ring-2 focus:ring-purple-500" value={selectedBranchFilter} onChange={(e) => setSelectedBranchFilter(e.target.value)}><option value="Semua">Semua Cawangan</option>{BRANCHES.map(b => <option key={b} value={b}>{b}</option>)}</select></div>
                                <div><label className="block text-xs font-bold text-purple-800 uppercase mb-1">Nama Guru</label><select className="w-full p-2 border border-purple-200 rounded text-sm focus:outline-none focus:ring-2 focus:ring-purple-500" value={selectedTeacherFilter} onChange={(e) => setSelectedTeacherFilter(e.target.value)}><option value="Semua">Semua Guru</option>{teachers.filter(t => selectedBranchFilter === 'Semua' || t.branch === selectedBranchFilter).map(t => <option key={t.id} value={t.name}>{t.name}</option>)}</select></div>
                            </div>
                            
                            {/* Special Wrapper for Printing Report */}
                            <div className={`${isPrintingReport ? 'report-print-mode' : ''}`}>
                                {isPrintingReport && (
                                    <div className="mb-6 text-center border-b pb-4">
                                        <h1 className="text-2xl font-bold uppercase">{schoolName}</h1>
                                        <p className="text-gray-600">Laporan Kehadiran - {selectedMonth} 2026</p>
                                    </div>
                                )}

                                <div className="grid grid-cols-3 gap-4 mb-6">
                                    <div className="bg-green-50 p-3 rounded-lg border border-green-100 text-center"><p className="text-xs text-green-600 font-bold uppercase">Hadir</p><p className="text-2xl font-bold text-green-800">{reportData.filter(r => r.status === 'Hadir').length}</p></div>
                                    <div className="bg-yellow-50 p-3 rounded-lg border border-yellow-100 text-center"><p className="text-xs text-yellow-600 font-bold uppercase">Cuti</p><p className="text-2xl font-bold text-yellow-800">{reportData.filter(r => r.status === 'Cuti').length}</p></div>
                                    <div className="bg-red-50 p-3 rounded-lg border border-red-100 text-center"><p className="text-xs text-red-600 font-bold uppercase">Tidak Hadir</p><p className="text-2xl font-bold text-red-800">{reportData.filter(r => r.status === 'Tidak Hadir').length}</p></div>
                                </div>
                                <div className="overflow-x-auto border rounded-lg"><table className="w-full text-sm text-left"><thead className="bg-gray-100 text-gray-700 uppercase text-xs"><tr><th className="px-4 py-3">Tarikh</th><th className="px-4 py-3">Nama Guru</th><th className="px-4 py-3">Cawangan</th><th className="px-4 py-3">Status</th><th className="px-4 py-3">Masuk</th><th className="px-4 py-3">Balik</th></tr></thead><tbody className="divide-y divide-gray-200">{reportData.map((row, idx) => (<tr key={idx} className="hover:bg-gray-50"><td className="px-4 py-2 font-mono text-gray-500">{row.date}</td><td className="px-4 py-2 font-medium text-gray-900">{row.name}</td><td className="px-4 py-2"><span className="px-2 py-0.5 bg-gray-100 rounded text-xs">{row.branch}</span></td><td className="px-4 py-2"><span className={`px-2 py-1 rounded text-xs font-bold ${row.status === 'Hadir' ? 'bg-green-100 text-green-700' : row.status === 'Cuti' ? 'bg-yellow-100 text-yellow-700' : row.status === '-' ? 'bg-gray-100 text-gray-400' : 'bg-red-100 text-red-700'}`}>{row.status}</span></td><td className="px-4 py-2 font-mono text-gray-600">{formatTime12(row.timeIn)}</td><td className="px-4 py-2 font-mono text-gray-600">{formatTime12(row.timeOut)}</td></tr>))} {reportData.length === 0 && (<tr><td colSpan="6" className="text-center py-8 text-gray-400">Tiada rekod dijumpai.</td></tr>)}</tbody></table></div>
                            </div>
                        </div>
                    )}
                    {adminTab === 'analysis' && (
                        <div className="space-y-6 animate-fade-in">
                            <div className="bg-white rounded-xl shadow-lg p-6 h-80">
                                <h3 className="font-bold mb-4">Analisa Tahunan (Simulasi)</h3>
                                {isRechartsLoaded ? (<ResponsiveContainer width="100%" height="100%"><BarChart data={annualData}><XAxis dataKey="name" /><Tooltip /><Legend /><Bar dataKey="hadir" name="Peratus Kehadiran" fill="#22c55e" /></BarChart></ResponsiveContainer>) : (<div className="flex h-full items-center justify-center text-gray-500">Graf akan dipaparkan di sini</div>)}
                            </div>
                        </div>
                    )}
                    {adminTab === 'settings' && (
                        <div className="bg-white rounded-xl shadow-lg p-6 animate-fade-in">
                            <h3 className="font-bold text-lg mb-4 flex items-center gap-2"><i className="ph ph-gear text-gray-600"></i> Tetapan Sistem</h3>
                            <div className="space-y-6">
                                <div className="p-4 bg-gray-50 border rounded-lg"><label className="block text-sm font-bold text-gray-700 mb-2">Nama Sekolah</label><input type="text" className="w-full p-2 border rounded" placeholder="Cth: PASTI AL-HUDA" value={schoolName} onChange={(e) => setSchoolName(e.target.value.toUpperCase())} /><p className="text-xs text-gray-500 mt-1">Nama ini akan dipaparkan di halaman utama dan laporan.</p></div>
                                <div className="p-4 bg-gray-50 border rounded-lg"><label className="block text-sm font-bold text-gray-700 mb-2">Pautan Logo (URL Image)</label><input type="text" className="w-full p-2 border rounded" placeholder="Cth: https://example.com/logo.png" value={logoUrl} onChange={(e) => setLogoUrl(e.target.value)} /><p className="text-xs text-gray-500 mt-1">Biarkan kosong untuk menggunakan ikon lalai.</p></div>
                                <div className="pt-4 border-t"><button onClick={handleSaveSettings} className="w-full flex items-center justify-center gap-2 px-6 py-3 bg-green-600 text-white font-bold rounded-lg shadow hover:bg-green-700 transition-all"><i className="ph ph-floppy-disk text-xl"></i> SIMPAN TETAPAN</button></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- MAIN APP COMPONENT ---

        function App() {
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [userRole, setUserRole] = useState(null); 
            const [currentUser, setCurrentUser] = useState(null);
            const [currentTeacher, setCurrentTeacher] = useState(null); 
            const [isFirebaseReady, setIsFirebaseReady] = useState(false);
            const [loadingProgress, setLoadingProgress] = useState(0); 
            const [isLoadingSkipped, setIsLoadingSkipped] = useState(false); 
            const [isDemoMode, setIsDemoMode] = useState(false);
            const [firebaseError, setFirebaseError] = useState(null);

            const [teachers, setTeachers] = useState([]);
            const [schoolName, setSchoolName] = useState('PASTI AL-HUDA');
            const [logoUrl, setLogoUrl] = useState('');

            const [view, setView] = useState('dashboard');
            const [adminTab, setAdminTab] = useState('overview');
            const [scanMode, setScanMode] = useState(null); 
            const [selectedTeacherId, setSelectedTeacherId] = useState('');
            const [leaveReason, setLeaveReason] = useState('');
            const [scanMessage, setScanMessage] = useState('');
            const [isPrinting, setIsPrinting] = useState(false);

            const [newTeacherName, setNewTeacherName] = useState('');
            const [newTeacherBranch, setNewTeacherBranch] = useState('PAH1');
            
            const isAdmin = userRole === 'admin';

            // --- ANIMATION & FIREBASE INIT WAIT ---
            useEffect(() => {
                const progressTimer = setInterval(() => {
                    setLoadingProgress(prev => {
                        if (prev >= 95 && !isFirebaseReady) return 95;
                        if (isFirebaseReady) return 100;
                        return prev + 5; 
                    });
                }, 20); 

                const checkFirebase = setInterval(() => {
                    if (window.firebaseOps) {
                         if (window.firebaseOps.mode === 'demo') setIsDemoMode(true);
                         if (window.firebaseInitError) setFirebaseError(window.firebaseInitError);

                         if (window.firebaseOps.mode === 'demo' || window.firebaseOps.auth) {
                            setIsFirebaseReady(true);
                            clearInterval(checkFirebase);
                         }
                    }
                }, 50); 

                return () => {
                    clearInterval(progressTimer);
                    clearInterval(checkFirebase);
                };
            }, [isFirebaseReady]);

            // --- FIREBASE AUTH ---
            useEffect(() => {
                if (!isFirebaseReady) return;
                if (!window.firebaseOps) return;

                const { auth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } = window.firebaseOps;
                
                const initAuth = async () => {
                    if (!auth.currentUser) {
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                try {
                                    await signInWithCustomToken(auth, __initial_auth_token);
                                } catch (tokenError) {
                                    console.warn("Custom token invalid, falling back to anonymous auth:", tokenError);
                                    await signInAnonymously(auth);
                                }
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Auto Auth Error", error);
                        }
                    }
                };
                initAuth();

                const unsubscribeAuth = onAuthStateChanged(auth, (user) => {
                    setCurrentUser(user);
                });

                return () => unsubscribeAuth();
            }, [isFirebaseReady]);

            // --- DATA SYNC ---
            useEffect(() => {
                if (!currentUser || !isFirebaseReady) return;
                if (!window.firebaseOps) return; 

                const { db, collection, doc, onSnapshot, appId } = window.firebaseOps;

                const teachersRef = collection(db, 'artifacts', appId, 'public', 'data', 'teachers');
                const unsubscribeTeachers = onSnapshot(teachersRef, (snapshot) => {
                    const teachersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setTeachers(teachersData);
                }, (error) => console.error("Sync error teachers:", error));

                const settingsRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'config');
                const unsubscribeSettings = onSnapshot(settingsRef, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        setSchoolName(data.schoolName || 'PASTI AL-HUDA');
                        setLogoUrl(data.logoUrl || '');
                    }
                }, (error) => console.error("Sync error settings:", error));

                return () => {
                    unsubscribeTeachers();
                    unsubscribeSettings();
                };
            }, [currentUser, isFirebaseReady]);

            // --- ACTIONS ---
            
            const handleAttendanceSubmit = async (teacherId, scanType, reason = '') => {
                if (!teacherId) return;

                if (!window.firebaseOps || !window.firebaseOps.auth.currentUser) {
                    const connected = await ensureAuthReady();
                    if (!connected) {
                        alert("Sistem belum bersedia. Sila periksa sambungan internet.");
                        return;
                    }
                }

                const now = new Date();
                const timeString = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                
                const { db, doc, updateDoc, appId } = window.firebaseOps;
                const teacherRef = doc(db, 'artifacts', appId, 'public', 'data', 'teachers', teacherId);

                let updateData = {};
                const type = scanType || scanMode;

                if (type === 'clock_in') updateData = { status: 'Hadir', timeIn: timeString, timeOut: '--:--', reason: '' };
                else if (type === 'clock_out') updateData = { timeOut: timeString };
                else if (type === 'leave') updateData = { status: 'Cuti', reason: reason || leaveReason, timeIn: '--:--', timeOut: '--:--' };
                else if (type === 'outstation') updateData = { status: 'Tugas Luar', reason: reason || leaveReason, timeIn: timeString, timeOut: '--:--' };

                try {
                    await updateDoc(teacherRef, updateData);
                    // Mesej kejayaan dipaparkan di komponen pemanggil (ScanView)
                } catch (e) {
                    alert("Ralat menyimpan data: " + e.message);
                }
            };

            const handlePrint = () => {
                setIsPrinting(true);
                setTimeout(() => { window.print(); setIsPrinting(false); }, 500);
            };

            const handleAddTeacher = async () => {
                if (!newTeacherName.trim()) { alert("Sila masukkan nama guru."); return; }
                
                if (!window.firebaseOps || !window.firebaseOps.auth.currentUser) {
                    const connected = await ensureAuthReady();
                    if (!connected) { alert("Sistem belum bersedia."); return; }
                }

                const { db, collection, addDoc, appId } = window.firebaseOps;
                
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'teachers'), {
                        name: newTeacherName,
                        branch: newTeacherBranch,
                        status: 'Tidak Hadir',
                        timeIn: '--:--',
                        timeOut: '--:--',
                        reason: ''
                    });
                    setNewTeacherName('');
                    alert(`Guru berjaya ditambah!`);
                } catch (e) {
                    alert("Ralat menambah guru: " + e.message);
                }
            };

            const handleDeleteTeacher = async (id) => {
                if (!window.firebaseOps || !window.firebaseOps.auth.currentUser) {
                     const connected = await ensureAuthReady();
                     if (!connected) return;
                }

                if (confirm("Adakah anda pasti? Data akan dipadam dari semua peranti.")) {
                    const { db, doc, deleteDoc, appId } = window.firebaseOps;
                    try {
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'teachers', id));
                    } catch (e) {
                        alert("Ralat memadam: " + e.message);
                    }
                }
            };

            const handleSaveSettings = async () => {
                if (!window.firebaseOps || !window.firebaseOps.auth.currentUser) {
                     const connected = await ensureAuthReady();
                     if (!connected) return;
                }

                const { db, doc, setDoc, appId } = window.firebaseOps;
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'config'), {
                        schoolName,
                        logoUrl
                    });
                    alert('Tetapan berjaya disimpan!');
                } catch (e) {
                    alert("Ralat menyimpan tetapan: " + e.message);
                }
            };

            const handleResetDaily = async () => {
                if(!confirm("Reset semua guru kepada 'Tidak Hadir'?")) return;
                if (!window.firebaseOps || !window.firebaseOps.auth.currentUser) {
                     const connected = await ensureAuthReady();
                     if (!connected) return;
                }
                
                const { db, doc, updateDoc, appId } = window.firebaseOps;
                
                teachers.forEach(async (t) => {
                    const ref = doc(db, 'artifacts', appId, 'public', 'data', 'teachers', t.id);
                    await updateDoc(ref, {
                        status: 'Tidak Hadir',
                        timeIn: '--:--',
                        timeOut: '--:--',
                        reason: ''
                    });
                });
                alert("Data harian telah di-reset.");
            };
            
            const handleLogout = () => {
                setIsLoggedIn(false);
                setUserRole(null);
                setCurrentTeacher(null);
                setView('dashboard');
                setScanMode(null);
            };

            const handleLogin = (role, teacherData = null) => {
                setUserRole(role);
                if (role === 'guru' && teacherData) {
                    setCurrentTeacher(teacherData);
                    setView('scan'); // Change to scan
                } else {
                    setView('dashboard');
                }
                setIsLoggedIn(true);
            };

            const handleSkipLoading = () => {
                setIsLoadingSkipped(true);
                setIsFirebaseReady(true); 
                ensureAuthReady();
            };

            if (!isLoadingSkipped && (loadingProgress < 100 || !isFirebaseReady)) {
                return <LoadingScreen progress={loadingProgress} onSkip={handleSkipLoading} errorMsg={firebaseError} mode={isDemoMode ? 'demo' : 'online'} />;
            }

            if (!isLoggedIn) return (
                <LoginScreen 
                    onLogin={handleLogin} 
                    schoolName={schoolName} 
                    logoUrl={logoUrl}
                    teachers={teachers}
                />
            );

            return (
                <div className="min-h-screen">
                    <Header 
                        userRole={userRole} 
                        view={view} 
                        setView={setView} 
                        isAdmin={isAdmin} 
                        onLogout={handleLogout}
                        schoolName={schoolName}
                        logoUrl={logoUrl}
                        isOnline={!!currentUser}
                        currentTeacher={currentTeacher}
                        isDemo={isDemoMode}
                    />
                    <div className="container mx-auto pb-10 pt-4">
                        {view === 'dashboard' && (
                            <DashboardView 
                                teachers={teachers} 
                                schoolName={schoolName} 
                                isDemo={isDemoMode} // Added prop
                            />
                        )}
                        {view === 'scan' && (
                            <ScanView 
                                scanMode={scanMode} 
                                setScanMode={setScanMode} 
                                teachers={teachers} 
                                currentTeacher={currentTeacher}
                                userRole={userRole}
                                selectedTeacherId={selectedTeacherId} 
                                setSelectedTeacherId={setSelectedTeacherId} 
                                leaveReason={leaveReason} 
                                setLeaveReason={setLeaveReason} 
                                scanMessage={scanMessage} 
                                handleAttendanceSubmit={handleAttendanceSubmit} 
                                handlePrint={handlePrint} 
                                isPrinting={isPrinting}
                                schoolName={schoolName}
                            />
                        )}
                        {view === 'admin' && (
                            <AdminView 
                                isAdmin={isAdmin} 
                                adminTab={adminTab} 
                                setAdminTab={setAdminTab} 
                                teachers={teachers} 
                                newTeacherName={newTeacherName} 
                                setNewTeacherName={setNewTeacherName} 
                                newTeacherBranch={newTeacherBranch} 
                                setNewTeacherBranch={setNewTeacherBranch} 
                                handleAddTeacher={handleAddTeacher} 
                                handleDeleteTeacher={handleDeleteTeacher}
                                schoolName={schoolName}
                                setSchoolName={setSchoolName}
                                logoUrl={logoUrl}
                                setLogoUrl={setLogoUrl}
                                handleSaveSettings={handleSaveSettings}
                                handleResetDaily={handleResetDaily}
                                isDemo={isDemoMode} // Added prop
                            />
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>