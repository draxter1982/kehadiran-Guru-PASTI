<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Kehadiran Guru PASTI AL-HUDA</title>
    
    <!-- 1. TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. REACT & REACT DOM -->
    <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- 3. RECHARTS & DEPENDENCIES -->
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.12.0/Recharts.min.js"></script>

    <!-- 4. BABEL -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 5. PHOSPHOR ICONS -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .loading-bar-transition { transition: width 0.1s linear; }

        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        }
        .print-only { display: none; }
    </style>

    <!-- 6. FIREBASE SETUP (MODULE) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        window.firebaseOps = { 
            auth, db, appId,
            signInAnonymously, signInWithCustomToken, onAuthStateChanged, 
            collection, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot 
        };
        console.log("Firebase initialized");
    </script>
</head>
<body class="bg-gray-50 text-gray-900 font-sans">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- SAFE RECHARTS ACCESS ---
        const RechartsObj = window.Recharts || {};
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, Cell } = RechartsObj;
        const isRechartsLoaded = !!window.Recharts;

        // --- CONSTANTS ---
        const BRANCHES = ['PAH1', 'PAH2', 'PAH3', 'PAH5'];
        const MONTHS = ['Januari', 'Februari', 'Mac', 'April', 'Mei', 'Jun', 'Julai', 'Ogos', 'September', 'Oktober', 'November', 'Disember'];

        // --- UTILS ---
        const seededRandom = (seed) => {
            let value = 0;
            for(let i=0; i<seed.length; i++) value += seed.charCodeAt(i);
            const x = Math.sin(value) * 10000;
            return x - Math.floor(x);
        };

        // --- COMPONENT: LOADING SCREEN (IMPROVED) ---
        const LoadingScreen = ({ progress, onSkip }) => (
            <div className="fixed inset-0 bg-green-700 flex flex-col items-center justify-center z-50 text-white">
                <div className="relative mb-8">
                    {/* Spinner */}
                    <div className="w-24 h-24 border-4 border-green-400 border-t-white rounded-full animate-spin"></div>
                    {/* Percentage Text - Centered and Larger */}
                    <div className="absolute inset-0 flex items-center justify-center font-bold text-xl drop-shadow-md">
                        {progress}%
                    </div>
                </div>
                
                <h1 className="text-3xl font-bold mb-2 tracking-wide drop-shadow-md">SISTEM PASTI</h1>
                <p className="text-green-100 text-sm mb-8 animate-pulse font-medium">Menghubungkan ke Awan...</p>
                
                {/* Progress Bar */}
                <div className="w-64 h-3 bg-green-900 rounded-full overflow-hidden shadow-inner border border-green-600">
                    <div 
                        className="h-full bg-white loading-bar-transition shadow-lg" 
                        style={{ width: `${progress}%` }}
                    ></div>
                </div>

                {/* Skip Button - Appears if loading feels stuck */}
                <button 
                    onClick={onSkip}
                    className="mt-8 text-xs font-bold text-green-200 hover:text-white underline hover:no-underline transition-colors opacity-80"
                >
                    Lambat? Tekan untuk Masuk Segera &gt;&gt;
                </button>
            </div>
        );

        // --- SUB-COMPONENTS ---
        const Header = ({ userRole, view, setView, isAdmin, onLogout, schoolName, logoUrl, isOnline }) => (
            <div className="bg-green-600 text-white p-4 shadow-md flex justify-between items-center sticky top-0 z-50 no-print">
                <div className="flex items-center gap-3">
                    {logoUrl ? (
                        <img src={logoUrl} alt="Logo" className="w-10 h-10 object-contain rounded-full bg-white p-1" />
                    ) : (
                        <i className="ph ph-user-check text-3xl"></i>
                    )}
                    <div>
                        <h1 className="text-xl font-bold leading-none uppercase">{schoolName || 'PASTI'}</h1>
                        <div className="flex items-center gap-2 text-xs text-green-100 opacity-90">
                            <span>{userRole === 'admin' ? 'Pentadbir' : 'Guru'}</span>
                            <span className="flex items-center gap-1 bg-green-800 px-1.5 rounded-full" title="Status Sambungan">
                                <span className={`w-2 h-2 rounded-full ${isOnline ? 'bg-green-400' : 'bg-red-500'}`}></span>
                                {isOnline ? 'Online' : 'Menunggu Sambungan...'}
                            </span>
                        </div>
                    </div>
                </div>
                <div className="flex gap-2">
                    <button onClick={() => setView('dashboard')} className={`px-3 py-1 rounded text-sm font-bold ${view === 'dashboard' ? 'bg-white text-green-700' : 'bg-green-700'}`}>Utama</button>
                    <button onClick={() => setView('scan')} className={`px-3 py-1 rounded text-sm font-bold ${view === 'scan' ? 'bg-white text-green-700' : 'bg-green-700'}`}>Scan</button>
                    
                    {isAdmin && (
                        <button onClick={() => setView('admin')} className={`px-3 py-1 rounded text-sm font-bold ${view === 'admin' ? 'bg-white text-green-700' : 'bg-green-700 border border-green-400'}`}>
                            Admin
                        </button>
                    )}
                    
                    <button onClick={onLogout} className="ml-2 px-3 py-1 rounded text-sm font-bold bg-red-600 hover:bg-red-700 flex items-center gap-1">
                        <i className="ph ph-sign-out"></i>
                    </button>
                </div>
            </div>
        );

        const LoginScreen = ({ onLogin, schoolName, logoUrl }) => {
            const [showPass, setShowPass] = useState(false);
            const [pass, setPass] = useState('');

            const loginGuru = () => onLogin('guru');
            const loginAdmin = () => {
                if (pass === 'admin123') onLogin('admin');
                else alert('Kata laluan salah!');
            };

            return (
                <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-xl w-full max-w-md overflow-hidden animate-fade-in">
                        <div className="bg-green-600 p-8 text-center">
                            <div className="inline-block p-4 bg-white rounded-full text-green-600 mb-4 shadow-lg">
                                {logoUrl ? <img src={logoUrl} className="w-16 h-16 object-contain" /> : <i className="ph ph-user-circle text-5xl"></i>}
                            </div>
                            <h1 className="text-2xl font-bold text-white">Sistem Kehadiran</h1>
                            <p className="text-green-100 opacity-90 uppercase">{schoolName || 'PASTI'}</p>
                        </div>
                        <div className="p-8 space-y-6">
                            {!showPass ? (
                                <>
                                    <p className="text-center text-gray-500 mb-4">Sila pilih akses:</p>
                                    <button onClick={loginGuru} className="w-full py-4 bg-blue-50 border-2 border-blue-100 rounded-xl hover:bg-blue-100 transition-all flex items-center justify-center gap-3 group">
                                        <i className="ph ph-chalkboard-teacher text-2xl text-blue-600"></i><span className="text-lg font-bold text-blue-800">Log Masuk GURU</span>
                                    </button>
                                    <button onClick={() => setShowPass(true)} className="w-full py-4 bg-gray-50 border-2 border-gray-100 rounded-xl hover:bg-gray-100 transition-all flex items-center justify-center gap-3 group">
                                        <i className="ph ph-lock-key text-2xl text-gray-600"></i><span className="text-lg font-bold text-gray-800">Log Masuk PENTADBIR</span>
                                    </button>
                                </>
                            ) : (
                                <div className="animate-fade-in">
                                    <h3 className="text-center font-bold text-gray-800 mb-4 text-lg">Akses Pentadbir</h3>
                                    <input type="password" className="w-full p-3 border-2 border-gray-200 rounded-lg mb-4 text-center focus:border-green-500 focus:outline-none" placeholder="Masukkan Kata Laluan" value={pass} onChange={(e) => setPass(e.target.value)} autoFocus />
                                    <button onClick={loginAdmin} className="w-full py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 shadow-md mb-3">Sahkan</button>
                                    <button onClick={() => {setShowPass(false); setPass('');}} className="w-full py-2 text-gray-500 text-sm hover:underline">Kembali</button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const DashboardView = ({ teachers }) => {
            const getChartData = () => {
                const stats = { Hadir: 0, 'Dalam Proses': 0, Cuti: 0, 'Tugas Luar': 0, 'Tidak Hadir': 0 };
                if (teachers) {
                    teachers.forEach(t => {
                        if (t.status === 'Hadir' && t.timeOut !== '--:--') stats['Hadir']++;
                        else if (t.status === 'Hadir' && t.timeOut === '--:--') stats['Dalam Proses']++;
                        else if (t.status === 'Cuti') stats['Cuti']++;
                        else if (t.status === 'Tugas Luar') stats['Tugas Luar']++;
                        else stats['Tidak Hadir']++;
                    });
                }
                return [
                    { name: 'Selesai', jumlah: stats['Hadir'], fill: '#22c55e' },
                    { name: 'Bertugas', jumlah: stats['Dalam Proses'], fill: '#3b82f6' },
                    { name: 'T. Luar', jumlah: stats['Tugas Luar'], fill: '#8b5cf6' },
                    { name: 'Cuti', jumlah: stats['Cuti'], fill: '#eab308' },
                    { name: 'Tiada', jumlah: stats['Tidak Hadir'], fill: '#ef4444' },
                ];
            };

            const data = getChartData();
            const today = new Date();
            const dateString = today.toLocaleDateString('ms-MY', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            return (
                <div className="p-4 space-y-6 max-w-5xl mx-auto animate-fade-in no-print">
                    <div className="grid grid-cols-2 md:grid-cols-5 gap-3">
                        {data.map((item, idx) => (
                            <div key={idx} className="bg-white p-3 rounded-lg shadow border-l-4" style={{ borderLeftColor: item.fill }}>
                                <p className="text-gray-500 text-xs font-semibold uppercase">{item.name}</p>
                                <p className="text-2xl font-bold text-gray-800">{item.jumlah}</p>
                            </div>
                        ))}
                    </div>

                    <div className="bg-white p-4 rounded-lg shadow">
                        <div className="flex flex-col md:flex-row justify-between items-center mb-4 gap-2">
                            <h3 className="text-lg font-bold text-gray-700 flex items-center gap-2"><i className="ph ph-chart-bar text-xl"></i> Statistik Harian</h3>
                            <div className="flex items-center gap-2 text-sm font-medium text-gray-600 bg-gray-100 px-3 py-1.5 rounded-full border">
                                <i className="ph ph-calendar text-green-600"></i> <span>{dateString}</span>
                            </div>
                        </div>
                        <div className="h-64 w-full flex items-center justify-center bg-gray-50 rounded">
                            {isRechartsLoaded ? (
                                <ResponsiveContainer width="100%" height="100%">
                                    <BarChart data={data} layout="vertical" margin={{ top: 5, right: 30, left: 20, bottom: 5 }}>
                                        <CartesianGrid strokeDasharray="3 3" horizontal={true} vertical={false} />
                                        <XAxis type="number" hide />
                                        <YAxis dataKey="name" type="category" width={80} tick={{fontSize: 12}} />
                                        <Tooltip cursor={{fill: 'transparent'}} />
                                        <Bar dataKey="jumlah" radius={[0, 4, 4, 0]} barSize={30}>
                                            {data.map((entry, index) => <Cell key={`cell-${index}`} fill={entry.fill} />)}
                                        </Bar>
                                    </BarChart>
                                </ResponsiveContainer>
                            ) : (
                                <div className="text-gray-500 text-sm">Graf sedang dimuatkan...</div>
                            )}
                        </div>
                    </div>

                    <div className="bg-white rounded-lg shadow overflow-hidden">
                        <div className="bg-gray-50 px-4 py-3 border-b flex justify-between items-center">
                            <h3 className="font-bold text-gray-700">Senarai Kehadiran Penuh</h3>
                            <div className="text-xs text-gray-400 italic">Data dikemaskini secara masa nyata (Real-time)</div>
                        </div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className="text-xs text-gray-700 uppercase bg-gray-100">
                                    <tr>
                                        <th className="px-4 py-3">Nama Guru</th>
                                        <th className="px-4 py-3">Cawangan</th>
                                        <th className="px-4 py-3">Masuk</th>
                                        <th className="px-4 py-3">Balik</th>
                                        <th className="px-4 py-3">Status</th>
                                        <th className="px-4 py-3">Catatan</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {teachers.map((t, idx) => {
                                        let statusColor = "bg-white", badgeColor = "bg-gray-100 text-gray-800";
                                        if (t.status === 'Tidak Hadir') { statusColor = "bg-red-50"; badgeColor = "bg-red-100 text-red-800"; }
                                        else if (t.status === 'Cuti') badgeColor = "bg-yellow-100 text-yellow-800";
                                        else if (t.status === 'Hadir') badgeColor = "bg-green-100 text-green-800";
                                        else if (t.status === 'Tugas Luar') badgeColor = "bg-purple-100 text-purple-800";

                                        return (
                                            <tr key={idx} className={`border-b ${statusColor}`}>
                                                <td className="px-4 py-3 font-medium">{t.name}</td>
                                                <td className="px-4 py-3"><span className="px-2 py-1 bg-gray-100 rounded text-xs font-mono">{t.branch}</span></td>
                                                <td className="px-4 py-3 font-mono text-gray-600">{t.timeIn}</td>
                                                <td className="px-4 py-3 font-mono text-gray-600">{t.timeOut}</td>
                                                <td className="px-4 py-3"><span className={`px-2 py-1 rounded text-xs font-semibold ${badgeColor}`}>{t.status}</span></td>
                                                <td className="px-4 py-3 text-gray-500 italic truncate max-w-xs">{t.reason || '-'}</td>
                                            </tr>
                                        );
                                    })}
                                    {teachers.length === 0 && (
                                        <tr><td colSpan="6" className="text-center py-4 text-gray-500">Tiada data guru.</td></tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        const ScanView = ({ scanMode, setScanMode, teachers, selectedTeacherId, setSelectedTeacherId, leaveReason, setLeaveReason, scanMessage, handleAttendanceSubmit, handlePrint, isPrinting, schoolName }) => {
            const handleTeacherChange = (e) => {
                const newId = e.target.value;
                setSelectedTeacherId(newId);
                // AUTO SUBMIT: Terus hantar data jika mod Masuk atau Balik dipilih
                if (newId && (scanMode === 'clock_in' || scanMode === 'clock_out')) {
                    handleAttendanceSubmit(newId); 
                }
            };

            return (
                <div className="p-4 md:p-8 max-w-6xl mx-auto">
                    <div className={`bg-white rounded-xl shadow-lg p-6 md:p-10 text-center space-y-8 no-print ${isPrinting ? 'hidden' : ''}`}>
                        {!scanMode ? (
                            <>
                                <div className="flex flex-col md:flex-row justify-between items-center gap-4 border-b pb-6">
                                    <div className="text-left">
                                        <h2 className="text-3xl font-bold text-gray-800">Sila Imbas QR</h2>
                                        <p className="text-gray-500">Pilih kod QR yang sesuai untuk aktiviti anda</p>
                                    </div>
                                    <button onClick={handlePrint} className="flex items-center gap-2 bg-gray-800 text-white px-5 py-3 rounded-lg shadow hover:bg-gray-900 transition-all">
                                        <i className="ph ph-printer text-xl"></i> Cetak QR
                                    </button>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mt-4">
                                    <div onClick={() => setScanMode('clock_in')} className="cursor-pointer bg-white border-2 border-blue-100 rounded-2xl p-6 hover:shadow-2xl hover:border-blue-500 transition-all">
                                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=PASTI_CLOCK_IN&color=1d4ed8" className="w-28 h-28 mx-auto mb-4" />
                                        <h3 className="text-xl font-bold text-blue-900 mb-2">QR MASUK</h3>
                                        <div className="flex items-center justify-center gap-2 text-blue-600 bg-blue-50 px-3 py-1 rounded-full text-sm font-semibold"><i className="ph ph-sign-in"></i> Datang</div>
                                    </div>
                                    <div onClick={() => setScanMode('clock_out')} className="cursor-pointer bg-white border-2 border-rose-100 rounded-2xl p-6 hover:shadow-2xl hover:border-rose-500 transition-all">
                                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=PASTI_CLOCK_OUT&color=be123c" className="w-28 h-28 mx-auto mb-4" />
                                        <h3 className="text-xl font-bold text-rose-900 mb-2">QR BALIK</h3>
                                        <div className="flex items-center justify-center gap-2 text-rose-600 bg-rose-50 px-3 py-1 rounded-full text-sm font-semibold"><i className="ph ph-sign-out"></i> Pulang</div>
                                    </div>
                                    <div onClick={() => setScanMode('outstation')} className="cursor-pointer bg-white border-2 border-purple-100 rounded-2xl p-6 hover:shadow-2xl hover:border-purple-500 transition-all">
                                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=PASTI_OUTSTATION&color=7e22ce" className="w-28 h-28 mx-auto mb-4" />
                                        <h3 className="text-xl font-bold text-purple-900 mb-2">TUGAS LUAR</h3>
                                        <div className="flex items-center justify-center gap-2 text-purple-600 bg-purple-50 px-3 py-1 rounded-full text-sm font-semibold"><i className="ph ph-briefcase"></i> Kursus</div>
                                    </div>
                                    <div onClick={() => setScanMode('leave')} className="cursor-pointer bg-white border-2 border-orange-100 rounded-2xl p-6 hover:shadow-2xl hover:border-orange-500 transition-all">
                                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=PASTI_LEAVE&color=c2410c" className="w-28 h-28 mx-auto mb-4" />
                                        <h3 className="text-xl font-bold text-orange-900 mb-2">CUTI / MC</h3>
                                        <div className="flex items-center justify-center gap-2 text-orange-600 bg-orange-50 px-3 py-1 rounded-full text-sm font-semibold"><i className="ph ph-calendar-x"></i> Cuti</div>
                                    </div>
                                </div>
                            </>
                        ) : (
                            <div className="max-w-md mx-auto text-left animate-fade-in py-8">
                                <div className="flex items-center gap-3 mb-6 pb-4 border-b">
                                    <div className="p-3 bg-gray-100 rounded-full"><i className="ph ph-scan text-2xl text-gray-600"></i></div>
                                    <div>
                                        <h3 className="font-bold text-xl text-gray-800">
                                            {scanMode === 'clock_in' ? 'Rekod Kehadiran (Masuk)' : 
                                             scanMode === 'clock_out' ? 'Rekod Pulang (Balik)' : 'Rekod Cuti/Luar'}
                                        </h3>
                                        <button onClick={() => { setScanMode(null); }} className="text-sm text-gray-500 underline">Kembali</button>
                                    </div>
                                </div>
                                <div className="space-y-4 bg-gray-50 p-6 rounded-lg border border-gray-200">
                                    <label className="block text-sm font-bold text-gray-700">Simulasi: Pilih ID Guru</label>
                                    <select className="w-full p-3 border rounded-lg bg-white" value={selectedTeacherId} onChange={handleTeacherChange}>
                                        <option value="">-- Sila Scan/Pilih ID --</option>
                                        {teachers.map(t => <option key={t.id} value={t.id}>{t.name} - {t.branch}</option>)}
                                    </select>
                                    
                                    {(scanMode === 'leave' || scanMode === 'outstation') && (
                                        <div className="animate-fade-in">
                                            <textarea className="w-full p-3 border rounded-lg mb-3" rows="3" placeholder="Nyatakan sebab/lokasi..." value={leaveReason} onChange={(e) => setLeaveReason(e.target.value)}></textarea>
                                            <button onClick={() => handleAttendanceSubmit(selectedTeacherId)} disabled={!selectedTeacherId} className={`w-full py-3 rounded-lg font-bold text-white ${selectedTeacherId ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-300'}`}>Sahkan & Hantar</button>
                                        </div>
                                    )}

                                    {(scanMode === 'clock_in' || scanMode === 'clock_out') && (
                                        <p className="text-center text-sm text-gray-500 italic mt-2">Data sedang dihantar secara automatik...</p>
                                    )}

                                    {scanMessage && <div className="p-3 bg-green-100 text-green-700 rounded-lg text-center font-bold mt-2 animate-bounce">{scanMessage}</div>}
                                </div>
                            </div>
                        )}
                    </div>
                    
                    {/* PRINT LAYOUT */}
                    <div className={`print-only ${isPrinting ? 'block' : 'hidden'} bg-white p-8 w-full`}>
                        <div className="text-center mb-8 border-b-2 border-gray-800 pb-4">
                            <h1 className="text-4xl font-bold text-gray-900">KOD QR KEHADIRAN {schoolName}</h1>
                            <p className="text-xl text-gray-600">PAH1 | PAH2 | PAH3 | PAH5</p>
                        </div>
                        <div className="grid grid-cols-2 gap-8 text-center">
                            <div className="border-4 border-blue-600 rounded-2xl p-6 flex flex-col items-center">
                                <h2 className="text-3xl font-extrabold text-blue-800 mb-2">QR MASUK</h2>
                                <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=PASTI_CLOCK_IN" className="w-40 h-40 border-2 mb-4" />
                                <p className="text-xl font-bold">REKOD DATANG</p>
                            </div>
                            <div className="border-4 border-rose-600 rounded-2xl p-6 flex flex-col items-center">
                                <h2 className="text-3xl font-extrabold text-rose-800 mb-2">QR BALIK</h2>
                                <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=PASTI_CLOCK_OUT" className="w-40 h-40 border-2 mb-4" />
                                <p className="text-xl font-bold">REKOD PULANG</p>
                            </div>
                                <div className="border-4 border-purple-600 rounded-2xl p-6 flex flex-col items-center">
                                <h2 className="text-3xl font-extrabold text-purple-800 mb-2">TUGAS LUAR</h2>
                                <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=PASTI_OUTSTATION" className="w-40 h-40 border-2 mb-4" />
                                <p className="text-xl font-bold">KURSUS</p>
                            </div>
                            <div className="border-4 border-orange-600 rounded-2xl p-6 flex flex-col items-center">
                                <h2 className="text-3xl font-extrabold text-orange-800 mb-2">CUTI / MC</h2>
                                <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=PASTI_LEAVE" className="w-40 h-40 border-2 mb-4" />
                                <p className="text-xl font-bold">TIDAK HADIR</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const AdminView = ({ 
            isAdmin, adminTab, setAdminTab, 
            teachers, 
            newTeacherName, setNewTeacherName, 
            newTeacherBranch, setNewTeacherBranch, 
            handleAddTeacher, handleDeleteTeacher,
            schoolName, setSchoolName,
            logoUrl, setLogoUrl,
            handleSaveSettings,
            handleResetDaily
        }) => {
            if (!isAdmin) return <div className="p-8 text-center text-red-600">Akses Ditolak</div>;

            // State untuk Laporan Bulanan
            const [selectedMonth, setSelectedMonth] = useState('Januari');
            const [selectedBranchFilter, setSelectedBranchFilter] = useState('Semua');
            const [selectedTeacherFilter, setSelectedTeacherFilter] = useState('Semua');

            // Generate report data on the fly (mocking with consistent random)
            const generateReportData = (month, branchFilter, teacherFilter, teachersList) => {
                const daysInMonth = 20; 
                let reportData = [];

                if(teachersList) {
                    teachersList.forEach(teacher => {
                        if (branchFilter !== 'Semua' && teacher.branch !== branchFilter) return;
                        if (teacherFilter !== 'Semua' && teacher.name !== teacherFilter) return;

                        for (let i = 1; i <= daysInMonth; i++) {
                            // Gunakan nama + tarikh sebagai benih (seed) untuk random
                            // Ini memastikan "fake data" sentiasa sama di semua device (tally)
                            const seed = teacher.name + i + month;
                            const statusRandom = seededRandom(seed);
                            
                            let status = 'Hadir';
                            let timeIn = `07:${Math.floor(seededRandom(seed + 'in') * 59).toString().padStart(2, '0')}`;
                            let timeOut = `13:${Math.floor(seededRandom(seed + 'out') * 30).toString().padStart(2, '0')}`;
                            
                            if (statusRandom > 0.9) { status = 'Cuti'; timeIn = '--:--'; timeOut = '--:--'; }
                            else if (statusRandom > 0.95) { status = 'Tidak Hadir'; timeIn = '--:--'; timeOut = '--:--'; }

                            reportData.push({
                                date: `${i} ${month} 2026`,
                                name: teacher.name,
                                branch: teacher.branch,
                                status: status,
                                timeIn: timeIn,
                                timeOut: timeOut
                            });
                        }
                    });
                }
                return reportData;
            };

            const reportData = React.useMemo(() => {
                return generateReportData(selectedMonth, selectedBranchFilter, selectedTeacherFilter, teachers);
            }, [selectedMonth, selectedBranchFilter, selectedTeacherFilter, teachers]);

            return (
                <div className="p-4 max-w-5xl mx-auto no-print">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold">Panel Pentadbir</h2>
                        <p className="text-gray-500 text-sm">Pengurusan Data Sekolah (Disinkron)</p>
                    </div>
                    <div className="flex gap-2 mb-6 border-b overflow-x-auto pb-2">
                        <button onClick={() => setAdminTab('overview')} className={`px-4 py-2 font-bold rounded-t-lg whitespace-nowrap ${adminTab === 'overview' ? 'bg-white text-blue-600 border-t border-x' : 'text-gray-500 hover:bg-gray-50'}`}>Pengurusan</button>
                        <button onClick={() => setAdminTab('teachers')} className={`px-4 py-2 font-bold rounded-t-lg whitespace-nowrap ${adminTab === 'teachers' ? 'bg-white text-blue-600 border-t border-x' : 'text-gray-500 hover:bg-gray-50'}`}>Senarai Guru</button>
                        <button onClick={() => setAdminTab('report')} className={`px-4 py-2 font-bold rounded-t-lg whitespace-nowrap ${adminTab === 'report' ? 'bg-white text-blue-600 border-t border-x' : 'text-gray-500 hover:bg-gray-50'}`}>Laporan Bulanan</button>
                        <button onClick={() => setAdminTab('analysis')} className={`px-4 py-2 font-bold rounded-t-lg whitespace-nowrap ${adminTab === 'analysis' ? 'bg-white text-blue-600 border-t border-x' : 'text-gray-500 hover:bg-gray-50'}`}>Analisa</button>
                        <button onClick={() => setAdminTab('settings')} className={`px-4 py-2 font-bold rounded-t-lg whitespace-nowrap ${adminTab === 'settings' ? 'bg-white text-blue-600 border-t border-x' : 'text-gray-500 hover:bg-gray-50'}`}>Tetapan</button>
                    </div>

                    {/* TAB 1: PENGURUSAN UMUM */}
                    {adminTab === 'overview' && (
                        <div className="bg-white rounded-xl shadow-lg p-8 animate-fade-in">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                                <button onClick={() => setAdminTab('teachers')} className="flex items-center justify-center gap-2 px-4 py-4 bg-white border-2 border-dashed border-gray-300 text-gray-600 rounded-xl hover:border-blue-500 hover:text-blue-600"><i className="ph ph-users text-xl"></i> Urus Senarai Guru</button>
                                <button className="flex items-center justify-center gap-2 px-4 py-4 bg-white border-2 border-dashed border-gray-300 text-gray-600 rounded-xl hover:border-green-500 hover:text-green-600"><i className="ph ph-file-csv text-xl"></i> Eksport Excel</button>
                            </div>
                            <div className="border-t pt-6 bg-red-50 p-4 rounded-lg flex justify-between items-center">
                                <div>
                                    <span className="text-red-700 font-bold block">Reset Harian</span>
                                    <span className="text-xs text-red-500">Tindakan ini akan menetapkan semua guru kepada "Tidak Hadir" di semua peranti.</span>
                                </div>
                                <button onClick={handleResetDaily} className="px-4 py-2 bg-white border border-red-200 text-red-600 rounded font-bold hover:bg-red-50">Reset Sekarang</button>
                            </div>
                        </div>
                    )}

                    {/* TAB 2: PENGURUSAN GURU */}
                    {adminTab === 'teachers' && (
                        <div className="bg-white rounded-xl shadow-lg p-6 animate-fade-in">
                            <h3 className="font-bold text-lg mb-4 flex items-center gap-2"><i className="ph ph-user-plus text-blue-600"></i> Tambah Guru Baru</h3>
                            <div className="flex flex-col md:flex-row gap-4 mb-8 p-4 bg-blue-50 rounded-lg">
                                <div className="flex-1">
                                    <label className="block text-sm font-bold text-blue-800 mb-1">Nama Penuh</label>
                                    <input 
                                        type="text" 
                                        className="w-full p-2 border rounded" 
                                        placeholder="Cth: Cikgu Ali" 
                                        value={newTeacherName}
                                        onChange={(e) => setNewTeacherName(e.target.value)}
                                    />
                                </div>
                                <div className="w-full md:w-48">
                                    <label className="block text-sm font-bold text-blue-800 mb-1">Cawangan</label>
                                    <select 
                                        className="w-full p-2 border rounded"
                                        value={newTeacherBranch}
                                        onChange={(e) => setNewTeacherBranch(e.target.value)}
                                    >
                                        {BRANCHES.map(b => <option key={b} value={b}>{b}</option>)}
                                    </select>
                                </div>
                                <div className="flex items-end">
                                    <button onClick={handleAddTeacher} className="w-full md:w-auto px-6 py-2 bg-blue-600 text-white font-bold rounded hover:bg-blue-700">Tambah</button>
                                </div>
                            </div>

                            <div className="flex justify-between items-center mb-4">
                                <h3 className="font-bold text-lg">Senarai Guru Sedia Ada</h3>
                                <div className="text-xs text-green-600 font-bold bg-green-50 px-2 py-1 rounded border border-green-200 flex items-center gap-1">
                                    <i className="ph ph-cloud-check"></i> Auto-Sync Aktif
                                </div>
                            </div>
                            
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm text-left border">
                                    <thead className="bg-gray-100 uppercase text-xs">
                                        <tr>
                                            <th className="px-4 py-3">Nama Guru</th>
                                            <th className="px-4 py-3">Cawangan</th>
                                            <th className="px-4 py-3 text-center">Tindakan</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {teachers.map((t) => (
                                            <tr key={t.id} className="border-b hover:bg-gray-50">
                                                <td className="px-4 py-3 font-bold">{t.name}</td>
                                                <td className="px-4 py-3"><span className="px-2 py-1 bg-gray-200 rounded text-xs">{t.branch}</span></td>
                                                <td className="px-4 py-3 text-center">
                                                    <button 
                                                        onClick={() => handleDeleteTeacher(t.id)}
                                                        className="text-red-600 hover:text-red-800 bg-red-50 hover:bg-red-100 px-3 py-1 rounded text-xs font-bold"
                                                    >
                                                        Padam
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                        {teachers.length === 0 && (
                                            <tr><td colSpan="4" className="text-center py-4 text-gray-500">Tiada guru didaftarkan.</td></tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                            <p className="text-xs text-gray-500 mt-4 italic">* Perubahan senarai guru disimpan secara automatik ke pangkalan data awan.</p>
                        </div>
                    )}

                    {/* TAB BARU: LAPORAN BULANAN */}
                    {adminTab === 'report' && (
                        <div className="bg-white rounded-xl shadow-lg p-6 animate-fade-in">
                            <h3 className="font-bold text-lg mb-6 flex items-center gap-2 text-purple-700">
                                <i className="ph ph-file-text text-xl"></i> Rekod Kehadiran Bulanan
                            </h3>

                            {/* Filters */}
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 bg-purple-50 p-4 rounded-lg">
                                <div>
                                    <label className="block text-xs font-bold text-purple-800 uppercase mb-1">Bulan</label>
                                    <select 
                                        className="w-full p-2 border border-purple-200 rounded text-sm focus:outline-none focus:ring-2 focus:ring-purple-500"
                                        value={selectedMonth}
                                        onChange={(e) => setSelectedMonth(e.target.value)}
                                    >
                                        {MONTHS.map(m => <option key={m} value={m}>{m}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-purple-800 uppercase mb-1">Cawangan</label>
                                    <select 
                                        className="w-full p-2 border border-purple-200 rounded text-sm focus:outline-none focus:ring-2 focus:ring-purple-500"
                                        value={selectedBranchFilter}
                                        onChange={(e) => setSelectedBranchFilter(e.target.value)}
                                    >
                                        <option value="Semua">Semua Cawangan</option>
                                        {BRANCHES.map(b => <option key={b} value={b}>{b}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-purple-800 uppercase mb-1">Nama Guru</label>
                                    <select 
                                        className="w-full p-2 border border-purple-200 rounded text-sm focus:outline-none focus:ring-2 focus:ring-purple-500"
                                        value={selectedTeacherFilter}
                                        onChange={(e) => setSelectedTeacherFilter(e.target.value)}
                                    >
                                        <option value="Semua">Semua Guru</option>
                                        {teachers
                                            .filter(t => selectedBranchFilter === 'Semua' || t.branch === selectedBranchFilter)
                                            .map(t => <option key={t.id} value={t.name}>{t.name}</option>)
                                        }
                                    </select>
                                </div>
                            </div>

                            {/* Summary Cards */}
                            <div className="grid grid-cols-3 gap-4 mb-6">
                                <div className="bg-green-50 p-3 rounded-lg border border-green-100 text-center">
                                    <p className="text-xs text-green-600 font-bold uppercase">Hadir</p>
                                    <p className="text-2xl font-bold text-green-800">{reportData.filter(r => r.status === 'Hadir').length}</p>
                                </div>
                                <div className="bg-yellow-50 p-3 rounded-lg border border-yellow-100 text-center">
                                    <p className="text-xs text-yellow-600 font-bold uppercase">Cuti</p>
                                    <p className="text-2xl font-bold text-yellow-800">{reportData.filter(r => r.status === 'Cuti').length}</p>
                                </div>
                                <div className="bg-red-50 p-3 rounded-lg border border-red-100 text-center">
                                    <p className="text-xs text-red-600 font-bold uppercase">Tidak Hadir</p>
                                    <p className="text-2xl font-bold text-red-800">{reportData.filter(r => r.status === 'Tidak Hadir').length}</p>
                                </div>
                            </div>

                            {/* Table */}
                            <div className="overflow-x-auto border rounded-lg">
                                <table className="w-full text-sm text-left">
                                    <thead className="bg-gray-100 text-gray-700 uppercase text-xs">
                                        <tr>
                                            <th className="px-4 py-3">Tarikh</th>
                                            <th className="px-4 py-3">Nama Guru</th>
                                            <th className="px-4 py-3">Cawangan</th>
                                            <th className="px-4 py-3">Status</th>
                                            <th className="px-4 py-3">Masuk</th>
                                            <th className="px-4 py-3">Balik</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-200">
                                        {reportData.map((row, idx) => (
                                            <tr key={idx} className="hover:bg-gray-50">
                                                <td className="px-4 py-2 font-mono text-gray-500">{row.date}</td>
                                                <td className="px-4 py-2 font-medium text-gray-900">{row.name}</td>
                                                <td className="px-4 py-2"><span className="px-2 py-0.5 bg-gray-100 rounded text-xs">{row.branch}</span></td>
                                                <td className="px-4 py-2">
                                                    <span className={`px-2 py-1 rounded text-xs font-bold 
                                                        ${row.status === 'Hadir' ? 'bg-green-100 text-green-700' : 
                                                          row.status === 'Cuti' ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'}`}>
                                                        {row.status}
                                                    </span>
                                                </td>
                                                <td className="px-4 py-2 font-mono text-gray-600">{row.timeIn}</td>
                                                <td className="px-4 py-2 font-mono text-gray-600">{row.timeOut}</td>
                                            </tr>
                                        ))}
                                        {reportData.length === 0 && (
                                            <tr><td colSpan="6" className="text-center py-8 text-gray-400">Tiada rekod dijumpai.</td></tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}

                    {/* TAB 3: ANALISA */}
                    {adminTab === 'analysis' && (
                        <div className="space-y-6 animate-fade-in">
                            <div className="bg-white rounded-xl shadow-lg p-6 h-80">
                                <h3 className="font-bold mb-4">Analisa Tahunan (Simulasi)</h3>
                                {isRechartsLoaded ? (
                                    <ResponsiveContainer width="100%" height="100%">
                                        <BarChart data={[]}><XAxis dataKey="name" /><Tooltip /><Legend /><Bar dataKey="hadir" fill="#22c55e" /></BarChart>
                                    </ResponsiveContainer>
                                ) : (
                                    <div className="flex h-full items-center justify-center text-gray-500">Graf akan dipaparkan di sini</div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* TAB 4: TETAPAN */}
                    {adminTab === 'settings' && (
                        <div className="bg-white rounded-xl shadow-lg p-6 animate-fade-in">
                            <h3 className="font-bold text-lg mb-4 flex items-center gap-2"><i className="ph ph-gear text-gray-600"></i> Tetapan Sistem</h3>
                            
                            <div className="space-y-6">
                                <div className="p-4 bg-gray-50 border rounded-lg">
                                    <label className="block text-sm font-bold text-gray-700 mb-2">Nama Sekolah</label>
                                    <input 
                                        type="text" 
                                        className="w-full p-2 border rounded" 
                                        placeholder="Cth: PASTI AL-HUDA" 
                                        value={schoolName}
                                        onChange={(e) => setSchoolName(e.target.value.toUpperCase())}
                                    />
                                    <p className="text-xs text-gray-500 mt-1">Nama ini akan dipaparkan di halaman utama dan laporan.</p>
                                </div>

                                <div className="p-4 bg-gray-50 border rounded-lg">
                                    <label className="block text-sm font-bold text-gray-700 mb-2">Pautan Logo (URL Image)</label>
                                    <input 
                                        type="text" 
                                        className="w-full p-2 border rounded" 
                                        placeholder="Cth: https://example.com/logo.png" 
                                        value={logoUrl}
                                        onChange={(e) => setLogoUrl(e.target.value)}
                                    />
                                    <p className="text-xs text-gray-500 mt-1">Biarkan kosong untuk menggunakan ikon lalai.</p>
                                </div>

                                <div className="pt-4 border-t">
                                    <button 
                                        onClick={handleSaveSettings}
                                        className="w-full flex items-center justify-center gap-2 px-6 py-3 bg-green-600 text-white font-bold rounded-lg shadow hover:bg-green-700 transition-all"
                                    >
                                        <i className="ph ph-floppy-disk text-xl"></i> SIMPAN TETAPAN
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- MAIN APP COMPONENT ---

        function App() {
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [userRole, setUserRole] = useState(null); 
            const [currentUser, setCurrentUser] = useState(null);
            const [isFirebaseReady, setIsFirebaseReady] = useState(false);
            const [loadingProgress, setLoadingProgress] = useState(0); 
            const [isLoadingSkipped, setIsLoadingSkipped] = useState(false); // New state to track skipped loading

            const [teachers, setTeachers] = useState([]);
            const [schoolName, setSchoolName] = useState('PASTI AL-HUDA');
            const [logoUrl, setLogoUrl] = useState('');

            const [view, setView] = useState('dashboard');
            const [adminTab, setAdminTab] = useState('overview');
            const [scanMode, setScanMode] = useState(null); 
            const [selectedTeacherId, setSelectedTeacherId] = useState('');
            const [leaveReason, setLeaveReason] = useState('');
            const [scanMessage, setScanMessage] = useState('');
            const [isPrinting, setIsPrinting] = useState(false);

            const [newTeacherName, setNewTeacherName] = useState('');
            const [newTeacherBranch, setNewTeacherBranch] = useState('PAH1');
            
            const isAdmin = userRole === 'admin';

            // --- ANIMATION & FIREBASE INIT WAIT ---
            useEffect(() => {
                const progressTimer = setInterval(() => {
                    setLoadingProgress(prev => {
                        // LAJUKAN LOADING: Tambah 5 setiap interval (lebih cepat)
                        if (prev >= 90 && !isFirebaseReady) return 90;
                        if (isFirebaseReady) return 100;
                        return prev + 5; 
                    });
                }, 20); // Interval lebih pendek (20ms)

                const checkFirebase = setInterval(() => {
                    if (window.firebaseOps && window.firebaseOps.auth) {
                        setIsFirebaseReady(true);
                        clearInterval(checkFirebase);
                    }
                }, 50); // Cek lebih kerap

                return () => {
                    clearInterval(progressTimer);
                    clearInterval(checkFirebase);
                };
            }, [isFirebaseReady]);

            // --- FIREBASE AUTH ---
            useEffect(() => {
                if (!isFirebaseReady) return;
                
                // SAFEGUARD: Check if firebaseOps actually exists before destructing
                if (!window.firebaseOps) return;

                const { auth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } = window.firebaseOps;
                
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Auth Error", error);
                    }
                };
                initAuth();

                const unsubscribeAuth = onAuthStateChanged(auth, (user) => {
                    setCurrentUser(user);
                });

                return () => unsubscribeAuth();
            }, [isFirebaseReady]);

            // --- DATA SYNC ---
            useEffect(() => {
                if (!currentUser || !isFirebaseReady) return;
                if (!window.firebaseOps) return; // SAFEGUARD

                const { db, collection, doc, onSnapshot, appId } = window.firebaseOps;

                // Sync Teachers
                const teachersRef = collection(db, 'artifacts', appId, 'public', 'data', 'teachers');
                const unsubscribeTeachers = onSnapshot(teachersRef, (snapshot) => {
                    const teachersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setTeachers(teachersData);
                }, (error) => console.error("Sync error teachers:", error));

                // Sync Settings
                const settingsRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'config');
                const unsubscribeSettings = onSnapshot(settingsRef, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        setSchoolName(data.schoolName || 'PASTI AL-HUDA');
                        setLogoUrl(data.logoUrl || '');
                    }
                }, (error) => console.error("Sync error settings:", error));

                return () => {
                    unsubscribeTeachers();
                    unsubscribeSettings();
                };
            }, [currentUser, isFirebaseReady]);

            // --- ACTIONS ---
            
            const handleAttendanceSubmit = async (autoSubmitId = null) => {
                const targetId = autoSubmitId || selectedTeacherId;
                if (!targetId) return;

                // SAFEGUARD: Check Firebase connection before attempting write
                if (!window.firebaseOps || !currentUser) {
                    alert("Sistem belum bersambung ke pangkalan data. Sila tunggu sebentar atau muat semula.");
                    return;
                }

                const now = new Date();
                const timeString = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                
                const { db, doc, updateDoc, appId } = window.firebaseOps;
                const teacherRef = doc(db, 'artifacts', appId, 'public', 'data', 'teachers', targetId);

                let updateData = {};
                if (scanMode === 'clock_in') updateData = { status: 'Hadir', timeIn: timeString, reason: '' };
                else if (scanMode === 'clock_out') updateData = { timeOut: timeString };
                else if (scanMode === 'leave') updateData = { status: 'Cuti', reason: leaveReason, timeIn: '--:--', timeOut: '--:--' };
                else if (scanMode === 'outstation') updateData = { status: 'Tugas Luar', reason: leaveReason, timeIn: timeString, timeOut: '--:--' };

                try {
                    await updateDoc(teacherRef, updateData);
                    setScanMessage(`Berjaya direkodkan pada ${timeString}`);
                    setTimeout(() => {
                        setScanMessage('');
                        setLeaveReason('');
                        setSelectedTeacherId('');
                        if (!autoSubmitId) { 
                             setView('dashboard');
                        }
                    }, 2000);
                } catch (e) {
                    alert("Ralat menyimpan data: " + e.message);
                }
            };

            const handlePrint = () => {
                setIsPrinting(true);
                setTimeout(() => { window.print(); setIsPrinting(false); }, 500);
            };

            const handleAddTeacher = async () => {
                if (!newTeacherName.trim()) {
                    alert("Sila masukkan nama guru.");
                    return;
                }
                
                if (!window.firebaseOps || !currentUser) {
                    alert("Sistem belum bersedia.");
                    return;
                }

                const { db, collection, addDoc, appId } = window.firebaseOps;
                
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'teachers'), {
                        name: newTeacherName,
                        branch: newTeacherBranch,
                        status: 'Tidak Hadir',
                        timeIn: '--:--',
                        timeOut: '--:--',
                        reason: ''
                    });
                    setNewTeacherName('');
                    alert(`Guru berjaya ditambah! Data disinkron secara automatik.`);
                } catch (e) {
                    alert("Ralat menambah guru: " + e.message);
                }
            };

            const handleDeleteTeacher = async (id) => {
                if (!window.firebaseOps || !currentUser) return;

                if (confirm("Adakah anda pasti? Data akan dipadam dari semua peranti.")) {
                    const { db, doc, deleteDoc, appId } = window.firebaseOps;
                    try {
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'teachers', id));
                    } catch (e) {
                        alert("Ralat memadam: " + e.message);
                    }
                }
            };

            const handleSaveSettings = async () => {
                if (!window.firebaseOps || !currentUser) return;

                const { db, doc, setDoc, appId } = window.firebaseOps;
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'config'), {
                        schoolName,
                        logoUrl
                    });
                    alert('Tetapan berjaya disimpan ke awan!');
                } catch (e) {
                    alert("Ralat menyimpan tetapan: " + e.message);
                }
            };

            const handleResetDaily = async () => {
                if(!confirm("Reset semua guru kepada 'Tidak Hadir'?")) return;
                if (!window.firebaseOps || !currentUser) return;
                
                const { db, doc, updateDoc, appId } = window.firebaseOps;
                
                teachers.forEach(async (t) => {
                    const ref = doc(db, 'artifacts', appId, 'public', 'data', 'teachers', t.id);
                    await updateDoc(ref, {
                        status: 'Tidak Hadir',
                        timeIn: '--:--',
                        timeOut: '--:--',
                        reason: ''
                    });
                });
                alert("Data harian telah di-reset.");
            };
            
            const handleLogout = () => {
                setIsLoggedIn(false);
                setUserRole(null);
                setView('dashboard');
                setScanMode(null);
            };

            const handleLogin = (role) => {
                setUserRole(role);
                setIsLoggedIn(true);
                setView('dashboard');
            };

            const handleSkipLoading = () => {
                setIsLoadingSkipped(true);
                // Force Firebase ready state true so UI renders, 
                // but safeguard checks will prevent crashes if it's really not ready
                setIsFirebaseReady(true); 
            };

            // PAPAR LOADING JIKA PROGRESS BELUM 100 DAN BELUM DISKIP
            // DAN JIKA FIREBASE BELUM READY (KECUALI DAH SKIP)
            if (!isLoadingSkipped && (loadingProgress < 100 || !isFirebaseReady)) {
                return <LoadingScreen progress={loadingProgress} onSkip={handleSkipLoading} />;
            }

            if (!isLoggedIn) return (
                <LoginScreen 
                    onLogin={handleLogin} 
                    schoolName={schoolName} 
                    logoUrl={logoUrl} 
                />
            );

            return (
                <div className="min-h-screen">
                    <Header 
                        userRole={userRole} 
                        view={view} 
                        setView={setView} 
                        isAdmin={isAdmin} 
                        onLogout={handleLogout}
                        schoolName={schoolName}
                        logoUrl={logoUrl}
                        isOnline={!!currentUser}
                    />
                    <div className="container mx-auto pb-10 pt-4">
                        {view === 'dashboard' && (
                            <DashboardView 
                                teachers={teachers} 
                                schoolName={schoolName} 
                            />
                        )}
                        {view === 'scan' && (
                            <ScanView 
                                scanMode={scanMode} 
                                setScanMode={setScanMode} 
                                teachers={teachers} 
                                selectedTeacherId={selectedTeacherId} 
                                setSelectedTeacherId={setSelectedTeacherId} 
                                leaveReason={leaveReason} 
                                setLeaveReason={setLeaveReason} 
                                scanMessage={scanMessage} 
                                handleAttendanceSubmit={handleAttendanceSubmit} 
                                handlePrint={handlePrint} 
                                isPrinting={isPrinting}
                                schoolName={schoolName}
                            />
                        )}
                        {view === 'admin' && (
                            <AdminView 
                                isAdmin={isAdmin} 
                                adminTab={adminTab} 
                                setAdminTab={setAdminTab} 
                                teachers={teachers} 
                                newTeacherName={newTeacherName} 
                                setNewTeacherName={setNewTeacherName} 
                                newTeacherBranch={newTeacherBranch} 
                                setNewTeacherBranch={setNewTeacherBranch} 
                                handleAddTeacher={handleAddTeacher} 
                                handleDeleteTeacher={handleDeleteTeacher}
                                schoolName={schoolName}
                                setSchoolName={setSchoolName}
                                logoUrl={logoUrl}
                                setLogoUrl={setLogoUrl}
                                handleSaveSettings={handleSaveSettings}
                                handleResetDaily={handleResetDaily}
                            />
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>